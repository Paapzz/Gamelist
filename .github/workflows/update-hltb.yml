name: Update HLTB

on:
  #20 —è–Ω–≤–∞—Ä—è –≤ 00:00 UTC
  schedule:
    - cron: '0 0 20 1 *'
  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # –ß–∞–Ω–∫ 0: –∏–≥—Ä—ã 1-350
  run-hltb-chunk-0:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    concurrency:
      group: hltb-worker-${{ github.run_id }}-chunk-0
      cancel-in-progress: false

    env:
      PYTHONUNBUFFERED: 1
      HLTB_DEBUG: "true"
      CHUNK_INDEX: "0"
      CHUNK_SIZE: "350"

    steps:
      - name: Checkout (with token for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-hltb-worker
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install required Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright pyee requests

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium

      - name: Show basic versions (non-fatal)
        run: |
          python -V
          python - <<'PY'
          import importlib
          for pkg in ("playwright","pyee","requests"):
              try:
                  mod = importlib.import_module(pkg)
                  print(pkg, getattr(mod, "__version__", "ok"))
              except Exception as e:
                  print(pkg, "NOT INSTALLED:", e)
          PY

      - name: "Run HLTB worker (Chunk 0: games 1-350)"
        env:
          HLTB_DEBUG: ${{ env.HLTB_DEBUG }}
          CHUNK_INDEX: ${{ env.CHUNK_INDEX }}
          CHUNK_SIZE: ${{ env.CHUNK_SIZE }}
        run: |
          echo "Starting hltb_worker.py (DEBUG=${HLTB_DEBUG}, CHUNK_INDEX=${CHUNK_INDEX}, CHUNK_SIZE=${CHUNK_SIZE})"
          python hltb_worker.py

      - name: Upload debug dumps (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-debug-dumps-chunk-0
          path: |
            debug_*.json
            hltb_debug.log
            progress.json
          if-no-files-found: warn

      - name: Upload hltb data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-data-chunk-0
          path: |
            hltb_data/*.json
          if-no-files-found: warn

      - name: Commit & push results (Chunk 0)
        if: always()
        env:
          GIT_AUTHOR_NAME: "HLTB Worker"
          GIT_AUTHOR_EMAIL: "hltb-worker@users.noreply.github.com"
        run: |
          set -euo pipefail
          echo "Preparing to commit results for chunk 0..."
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git checkout main

          CHANGED=0
          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
            CHANGED=1
          fi
          if [ -f index.html ]; then
            git add index.html
            CHANGED=1
          fi
          if [ -f progress.json ]; then
            git add progress.json
            CHANGED=1
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "No output files to commit. Exiting."
            exit 0
          fi

          MSG_PARTS=()
          if git diff --cached --name-only | grep -q '^index.html$'; then MSG_PARTS+=("index.html"); fi
          if git diff --cached --name-only | grep -q '^hltb_data/'; then MSG_PARTS+=("hltb_data"); fi
          if git diff --cached --name-only | grep -q '^progress.json$'; then MSG_PARTS+=("progress.json"); fi
          if [ ${#MSG_PARTS[@]} -eq 0 ]; then
            COMMIT_MSG="Update"
          else
            COMMIT_MSG="Update ${MSG_PARTS[*]}"
          fi
          
          if git diff --cached --quiet; then
            echo "No changes staged for commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          git fetch origin main

          set +e
          git merge --no-edit -s recursive -X ours origin/main
          MERGE_RC=$?
          set -e

          if [ $MERGE_RC -ne 0 ]; then
            echo "‚ö†Ô∏è Merge returned non-zero rc=${MERGE_RC}. Will create fallback branch to avoid overwriting remote unexpectedly."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please review and merge manually."
            exit 0
          fi

          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
          fi
          if [ -f index.html ]; then
            git add index.html
          fi
          if [ -f progress.json ]; then
            git add progress.json
          fi

          if git diff --cached --quiet; then
            echo "No post-merge changes to commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          set +e
          git push origin HEAD:main
          PUSH_RC=$?
          set -e

          if [ $PUSH_RC -eq 0 ]; then
            echo "‚úÖ Pushed results to main"
            exit 0
          else
            echo "‚ö†Ô∏è Push to main failed (RC=$PUSH_RC). Creating fallback branch and pushing there."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please merge manually."
            exit 0
          fi

  # –ß–∞–Ω–∫ 1: –∏–≥—Ä—ã 351-700
  run-hltb-chunk-1:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    concurrency:
      group: hltb-worker-${{ github.run_id }}-chunk-1
      cancel-in-progress: false
    needs: run-hltb-chunk-0

    env:
      PYTHONUNBUFFERED: 1
      HLTB_DEBUG: "true"
      CHUNK_INDEX: "1"
      CHUNK_SIZE: "350"

    steps:
      - name: Checkout (with token for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Pull latest changes from previous chunk
        run: |
          git config user.name "HLTB Worker"
          git config user.email "hltb-worker@users.noreply.github.com"
          git pull origin main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-hltb-worker
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install required Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright pyee requests

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium

      - name: Show basic versions (non-fatal)
        run: |
          python -V
          python - <<'PY'
          import importlib
          for pkg in ("playwright","pyee","requests"):
              try:
                  mod = importlib.import_module(pkg)
                  print(pkg, getattr(mod, "__version__", "ok"))
              except Exception as e:
                  print(pkg, "NOT INSTALLED:", e)
          PY

      - name: "Run HLTB worker (Chunk 1: games 351-700)"
        env:
          HLTB_DEBUG: ${{ env.HLTB_DEBUG }}
          CHUNK_INDEX: ${{ env.CHUNK_INDEX }}
          CHUNK_SIZE: ${{ env.CHUNK_SIZE }}
        run: |
          echo "Starting hltb_worker.py (DEBUG=${HLTB_DEBUG}, CHUNK_INDEX=${CHUNK_INDEX}, CHUNK_SIZE=${CHUNK_SIZE})"
          python hltb_worker.py

      - name: Upload debug dumps (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-debug-dumps-chunk-1
          path: |
            debug_*.json
            hltb_debug.log
            progress.json
          if-no-files-found: warn

      - name: Upload hltb data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-data-chunk-1
          path: |
            hltb_data/*.json
          if-no-files-found: warn

      - name: Commit & push results (Chunk 1)
        if: always()
        env:
          GIT_AUTHOR_NAME: "HLTB Worker"
          GIT_AUTHOR_EMAIL: "hltb-worker@users.noreply.github.com"
        run: |
          set -euo pipefail
          echo "Preparing to commit results for chunk 1..."
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git checkout main

          CHANGED=0
          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
            CHANGED=1
          fi
          if [ -f index.html ]; then
            git add index.html
            CHANGED=1
          fi
          if [ -f progress.json ]; then
            git add progress.json
            CHANGED=1
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "No output files to commit. Exiting."
            exit 0
          fi

          MSG_PARTS=()
          if git diff --cached --name-only | grep -q '^index.html$'; then MSG_PARTS+=("index.html"); fi
          if git diff --cached --name-only | grep -q '^hltb_data/'; then MSG_PARTS+=("hltb_data"); fi
          if git diff --cached --name-only | grep -q '^progress.json$'; then MSG_PARTS+=("progress.json"); fi
          if [ ${#MSG_PARTS[@]} -eq 0 ]; then
            COMMIT_MSG="Update"
          else
            COMMIT_MSG="Update ${MSG_PARTS[*]}"
          fi
          
          if git diff --cached --quiet; then
            echo "No changes staged for commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          git fetch origin main

          set +e
          git merge --no-edit -s recursive -X ours origin/main
          MERGE_RC=$?
          set -e

          if [ $MERGE_RC -ne 0 ]; then
            echo "‚ö†Ô∏è Merge returned non-zero rc=${MERGE_RC}. Will create fallback branch to avoid overwriting remote unexpectedly."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please review and merge manually."
            exit 0
          fi

          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
          fi
          if [ -f index.html ]; then
            git add index.html
          fi
          if [ -f progress.json ]; then
            git add progress.json
          fi

          if git diff --cached --quiet; then
            echo "No post-merge changes to commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          set +e
          git push origin HEAD:main
          PUSH_RC=$?
          set -e

          if [ $PUSH_RC -eq 0 ]; then
            echo "‚úÖ Pushed results to main"
            exit 0
          else
            echo "‚ö†Ô∏è Push to main failed (RC=$PUSH_RC). Creating fallback branch and pushing there."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please merge manually."
            exit 0
          fi

  # –ß–∞–Ω–∫ 2: –∏–≥—Ä—ã 701-1000
  run-hltb-chunk-2:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    concurrency:
      group: hltb-worker-${{ github.run_id }}-chunk-2
      cancel-in-progress: false
    needs: run-hltb-chunk-1

    env:
      PYTHONUNBUFFERED: 1
      HLTB_DEBUG: "true"
      CHUNK_INDEX: "2"
      CHUNK_SIZE: "350"

    steps:
      - name: Checkout (with token for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Pull latest changes from previous chunk
        run: |
          git config user.name "HLTB Worker"
          git config user.email "hltb-worker@users.noreply.github.com"
          git pull origin main

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-hltb-worker
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install required Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright pyee requests

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium

      - name: Show basic versions (non-fatal)
        run: |
          python -V
          python - <<'PY'
          import importlib
          for pkg in ("playwright","pyee","requests"):
              try:
                  mod = importlib.import_module(pkg)
                  print(pkg, getattr(mod, "__version__", "ok"))
              except Exception as e:
                  print(pkg, "NOT INSTALLED:", e)
          PY

      - name: "Run HLTB worker (Chunk 2: games 701-1000)"
        env:
          HLTB_DEBUG: ${{ env.HLTB_DEBUG }}
          CHUNK_INDEX: ${{ env.CHUNK_INDEX }}
          CHUNK_SIZE: ${{ env.CHUNK_SIZE }}
        run: |
          echo "Starting hltb_worker.py (DEBUG=${HLTB_DEBUG}, CHUNK_INDEX=${CHUNK_INDEX}, CHUNK_SIZE=${CHUNK_SIZE})"
          python hltb_worker.py

      - name: Upload debug dumps (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-debug-dumps-chunk-2
          path: |
            debug_*.json
            hltb_debug.log
            progress.json
          if-no-files-found: warn

      - name: Upload hltb data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-data-chunk-2
          path: |
            hltb_data/*.json
          if-no-files-found: warn

      - name: Commit & push results (Chunk 2)
        if: always()
        env:
          GIT_AUTHOR_NAME: "HLTB Worker"
          GIT_AUTHOR_EMAIL: "hltb-worker@users.noreply.github.com"
        run: |
          set -euo pipefail
          echo "Preparing to commit results for chunk 2..."
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git checkout main

          CHANGED=0
          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
            CHANGED=1
          fi
          if [ -f index.html ]; then
            git add index.html
            CHANGED=1
          fi
          if [ -f progress.json ]; then
            git add progress.json
            CHANGED=1
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "No output files to commit. Exiting."
            exit 0
          fi

          MSG_PARTS=()
          if git diff --cached --name-only | grep -q '^index.html$'; then MSG_PARTS+=("index.html"); fi
          if git diff --cached --name-only | grep -q '^hltb_data/'; then MSG_PARTS+=("hltb_data"); fi
          if git diff --cached --name-only | grep -q '^progress.json$'; then MSG_PARTS+=("progress.json"); fi
          if [ ${#MSG_PARTS[@]} -eq 0 ]; then
            COMMIT_MSG="Update"
          else
            COMMIT_MSG="Update ${MSG_PARTS[*]}"
          fi
          
          if git diff --cached --quiet; then
            echo "No changes staged for commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          git fetch origin main

          set +e
          git merge --no-edit -s recursive -X ours origin/main
          MERGE_RC=$?
          set -e

          if [ $MERGE_RC -ne 0 ]; then
            echo "‚ö†Ô∏è Merge returned non-zero rc=${MERGE_RC}. Will create fallback branch to avoid overwriting remote unexpectedly."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please review and merge manually."
            exit 0
          fi

          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
          fi
          if [ -f index.html ]; then
            git add index.html
          fi
          if [ -f progress.json ]; then
            git add progress.json
          fi

          if git diff --cached --quiet; then
            echo "No post-merge changes to commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          set +e
          git push origin HEAD:main
          PUSH_RC=$?
          set -e

          if [ $PUSH_RC -eq 0 ]; then
            echo "‚úÖ Pushed results to main"
            exit 0
          else
            echo "‚ö†Ô∏è Push to main failed (RC=$PUSH_RC). Creating fallback branch and pushing there."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please merge manually."
            exit 0
          fi
