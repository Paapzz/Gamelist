name: Update HLTB Data

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ñ€Ð°Ð· Ð² Ð³Ð¾Ð´ - 20 ÑÐ½Ð²Ð°Ñ€Ñ Ð² 00:00 UTC
  schedule:
    - cron: '0 0 20 1 *'
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:

jobs:
  update-hltb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright requests
          playwright install chromium
      
      - name: Run HLTB scraper
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ hltb_data ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          mkdir -p hltb_data
          echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¿Ð°Ð¿ÐºÐ° hltb_data"
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð²Ð¾Ñ€ÐºÐµÑ€
          python hltb_worker.py
        continue-on-error: true
      
      - name: Generate report
        if: always()
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
          python -c "
          import json
          from datetime import datetime
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          try:
              with open('hltb_data/hltb_data.json', 'r', encoding='utf-8') as f:
                  games_data = []
                  for line in f:
                      if line.strip():
                          games_data.append(json.loads(line))
              
              # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
              total_games = len(games_data)
              successful = len([g for g in games_data if 'hltb' in g])
              success_rate = (successful / total_games * 100) if total_games > 0 else 0
              
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
              report = {
                  'timestamp': datetime.now().isoformat(),
                  'total_games': total_games,
                  'successful_games': successful,
                  'failed_games': total_games - successful,
                  'success_rate': f'{success_rate:.1f}%',
                  'test_mode': 'false'
              }
              
              with open('scraping_report.json', 'w', encoding='utf-8') as f:
                  json.dump(report, f, indent=2, ensure_ascii=False)
              
              print(f'ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½: {successful}/{total_games} Ð¸Ð³Ñ€ ({success_rate:.1f}%)')
              
          except Exception as e:
              print(f'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°: {e}')
          "
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hltb-data-${{ github.run_number }}
          path: |
            hltb_data/hltb_data.json
            scraping_report.json
          retention-days: 30
      
      - name: Commit and push results
        if: always()
        run: |
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚
          if [ -f "hltb_data/hltb_data.json" ]; then
            git add hltb_data/hltb_data.json
            echo "âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ hltb_data/hltb_data.json"
          else
            echo "âš ï¸ Ð¤Ð°Ð¹Ð» hltb_data/hltb_data.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
          
          if [ -f "scraping_report.json" ]; then
            git add scraping_report.json
            echo "âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ scraping_report.json"
          else
            echo "âš ï¸ Ð¤Ð°Ð¹Ð» scraping_report.json Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
          
          if [ -f "index111.html" ]; then
            git add index111.html
            echo "âœ… Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ index111.html"
          else
            echo "âš ï¸ Ð¤Ð°Ð¹Ð» index111.html Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
          
          # Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð² - ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼
          git pull --rebase origin main
          
          # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Update HLTB data - $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          - Total games: $(jq '.total_games' scraping_report.json)
          - Success rate: $(jq -r '.success_rate' scraping_report.json)
          - Test mode: $(jq -r '.test_mode' scraping_report.json)
          
          Generated by GitHub Actions workflow #${{ github.run_number }}" && git push)
      
      
      - name: Create summary
        if: always()
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ñ€ÐµÐ·ÑŽÐ¼Ðµ
          if [ -f "scraping_report.json" ]; then
            echo "## HLTB Scraping Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Games | $(jq '.total_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Successful | $(jq '.successful_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $(jq '.failed_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Success Rate | $(jq -r '.success_rate' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Test Mode | $(jq -r '.test_mode' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Artifacts:** hltb-data-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
