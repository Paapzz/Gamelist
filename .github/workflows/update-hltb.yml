name: Update HLTB Data

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ñ€Ð°Ð· Ð² Ð³Ð¾Ð´ - 20 ÑÐ½Ð²Ð°Ñ€Ñ Ð² 00:00 UTC
  schedule:
    - cron: '0 0 20 1 *'
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ð¸Ð³Ñ€)'
        required: false
        default: false
        type: boolean

jobs:
  update-hltb:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          cd scrapper/HLTBscrapper
          pip install playwright requests
          playwright install chromium
      
      - name: ðŸ§ª Test mode check
        id: test_mode
        run: |
          if [ "${{ github.event.inputs.test_mode }}" = "true" ]; then
            echo "test_mode=true" >> $GITHUB_OUTPUT
            echo "ðŸ§ª Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ð¸Ð³Ñ€"
          else
            echo "test_mode=false" >> $GITHUB_OUTPUT
            echo "ðŸš€ ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼: Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÐ¼ Ð²ÑÐµ 1000 Ð¸Ð³Ñ€"
          fi
      
      - name: ðŸŽ® Run HLTB scraper
        run: |
          # Ð•ÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
          if [ "${{ steps.test_mode.outputs.test_mode }}" = "true" ]; then
            echo "ðŸ§ª Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð· 10 Ð¸Ð³Ñ€..."
            python -c "
          import json
          import sys
          sys.path.append('scrapper/HLTBscrapper')
          from hltb_worker import extract_games_list
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
          games = extract_games_list('index.html')
          
          # Ð‘ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 10 Ð¸Ð³Ñ€
          test_games = games[:10]
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ HTML Ñ„Ð°Ð¹Ð» Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
          with open('test_games.html', 'w', encoding='utf-8') as f:
              f.write(f'const gamesList = {json.dumps(test_games, indent=2, ensure_ascii=False)};')
              
          print(f'âœ… Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð· {len(test_games)} Ð¸Ð³Ñ€')
          "
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº Ñ„Ð°Ð¹Ð»Ñƒ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ Ñ€ÐµÐ¶Ð¸Ð¼Ð°
            sed -i "s|GAMES_LIST_FILE = \"index.html\"|GAMES_LIST_FILE = \"test_games.html\"|" scrapper/HLTBscrapper/hltb_worker.py
          fi
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð°Ð¿Ð¿ÐµÑ€
          python scrapper/HLTBscrapper/hltb_worker.py
        continue-on-error: true
      
      - name: ðŸ“Š Generate report
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
          python -c "
          import json
          from datetime import datetime
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
          try:
              with open('hltb_data/hltb_data.json', 'r', encoding='utf-8') as f:
                  games_data = []
                  for line in f:
                      if line.strip():
                          games_data.append(json.loads(line))
              
              # Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
              total_games = len(games_data)
              successful = len([g for g in games_data if 'hltb' in g])
              success_rate = (successful / total_games * 100) if total_games > 0 else 0
              
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ñ‡ÐµÑ‚
              report = {
                  'timestamp': datetime.now().isoformat(),
                  'total_games': total_games,
                  'successful_games': successful,
                  'failed_games': total_games - successful,
                  'success_rate': f'{success_rate:.1f}%',
                  'test_mode': '${{ steps.test_mode.outputs.test_mode }}'
              }
              
              with open('scraping_report.json', 'w', encoding='utf-8') as f:
                  json.dump(report, f, indent=2, ensure_ascii=False)
              
              print(f'ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½: {successful}/{total_games} Ð¸Ð³Ñ€ ({success_rate:.1f}%)')
              
          except Exception as e:
              print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°: {e}')
          "
        continue-on-error: true
      
      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hltb-data-${{ github.run_number }}
          path: |
            hltb_data/hltb_data.json
            scraping_report.json
          retention-days: 30
        if-no-files-found: warn
      
      - name: ðŸ’¾ Commit and push results
        run: |
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
          git add hltb_data/hltb_data.json
          git add scraping_report.json
          git add index.html
          
          # Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð² - ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼
          git pull --rebase origin main
          
          # ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ¤– Update HLTB data - $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          - Total games: $(jq '.total_games' scraping_report.json)
          - Success rate: $(jq -r '.success_rate' scraping_report.json)
          - Test mode: $(jq -r '.test_mode' scraping_report.json)
          
          Generated by GitHub Actions workflow #${{ github.run_number }}" && git push)
      
      - name: ðŸ§¹ Cleanup test files
        if: steps.test_mode.outputs.test_mode == 'true'
        run: |
          rm -f test_games.html
          echo "ðŸ§¹ Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹"
        continue-on-error: true
      
      - name: ðŸ“§ Create summary
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÑ€Ð°Ñ‚ÐºÐ¾Ðµ Ñ€ÐµÐ·ÑŽÐ¼Ðµ
          if [ -f "scraping_report.json" ]; then
            echo "## ðŸ“Š HLTB Scraping Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Games | $(jq '.total_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Successful | $(jq '.successful_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $(jq '.failed_games' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Success Rate | $(jq -r '.success_rate' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "| Test Mode | $(jq -r '.test_mode' scraping_report.json) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Artifacts:** hltb-data-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ÐžÑ‚Ñ‡ÐµÑ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
