name: Update HLTB

on:
  workflow_dispatch:
    inputs:
      CHUNK_INDEX:
        description: 'Chunk index (0..n). 0 means full list'
        required: false
        default: '0'
      CHUNK_SIZE:
        description: 'Chunk size per job (0 = all)'
        required: false
        default: '0'
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  run-hltb:
    runs-on: ubuntu-latest
    # –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–µ—á–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 6 —á–∞—Å–æ–≤ (360 –º–∏–Ω—É—Ç)
    timeout-minutes: 360
    # concurrency: –¥–µ–ª–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é –≥—Ä—É–ø–ø—É –ø–æ run_id + chunk, —á—Ç–æ–±—ã –ø–æ–∑–≤–æ–ª–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —á–∞–Ω–∫–∏ –≤ –æ–¥–Ω–æ–º run
    concurrency:
      group: hltb-worker-${{ github.run_id }}-${{ github.event.inputs.CHUNK_INDEX }}
      cancel-in-progress: false

    env:
      PYTHONUNBUFFERED: 1
      HLTB_DEBUG: "true"

    steps:
      - name: Checkout (with token for push)
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-hltb-worker
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install required Python packages
        run: |
          python -m pip install --upgrade pip
          python -m pip install playwright pyee requests

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium

      - name: Show basic versions (non-fatal)
        run: |
          python -V
          python - <<'PY'
          import importlib
          for pkg in ("playwright","pyee","requests"):
              try:
                  mod = importlib.import_module(pkg)
                  print(pkg, getattr(mod, "__version__", "ok"))
              except Exception as e:
                  print(pkg, "NOT INSTALLED:", e)
          PY

      - name: Prepare env vars (CHUNK_INDEX / CHUNK_SIZE)
        id: prepare_env
        run: |
          INPUT_CHUNK_INDEX="${{ github.event.inputs.CHUNK_INDEX }}"
          INPUT_CHUNK_SIZE="${{ github.event.inputs.CHUNK_SIZE }}"
          CHUNK_INDEX="${INPUT_CHUNK_INDEX:-0}"
          CHUNK_SIZE="${INPUT_CHUNK_SIZE:-0}"
          echo "CHUNK_INDEX=${CHUNK_INDEX}"
          echo "CHUNK_SIZE=${CHUNK_SIZE}"
          echo "CHUNK_INDEX=${CHUNK_INDEX}" >> $GITHUB_ENV
          echo "CHUNK_SIZE=${CHUNK_SIZE}" >> $GITHUB_ENV

      - name: Run HLTB worker
        env:
          HLTB_DEBUG: ${{ env.HLTB_DEBUG }}
          CHUNK_INDEX: ${{ env.CHUNK_INDEX }}
          CHUNK_SIZE: ${{ env.CHUNK_SIZE }}
        run: |
          echo "Starting hltb_worker.py (DEBUG=${HLTB_DEBUG}, CHUNK_INDEX=${CHUNK_INDEX}, CHUNK_SIZE=${CHUNK_SIZE})"
          python hltb_worker.py

      - name: Upload debug dumps (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-debug-dumps
          path: |
            debug_*.json
            hltb_debug.log
            progress.json
          if-no-files-found: warn

      - name: Upload hltb data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hltb-data
          path: |
            hltb_data/*.json
            *.html
          if-no-files-found: warn

      - name: Commit & push results back to main (safe merge strategy)
        if: always()
        env:
          GIT_AUTHOR_NAME: "HLTB Worker"
          GIT_AUTHOR_EMAIL: "hltb-worker@users.noreply.github.com"
        run: |
          set -euo pipefail
          echo "Preparing to commit results..."
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git checkout main

          CHANGED=0
          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
            CHANGED=1
          fi
          if [ -f index111.html ]; then
            git add index111.html
            CHANGED=1
          fi
          if [ -f progress.json ]; then
            git add progress.json
            CHANGED=1
          fi

          if [ "$CHANGED" -eq 0 ]; then
            echo "No output files to commit. Exiting."
            exit 0
          fi

          COMMIT_MSG="HLTB worker: update results $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          if git diff --cached --quiet; then
            echo "No changes staged for commit"
          else
            git commit -m "${COMMIT_MSG}"
          fi

          git fetch origin main

          set +e
          git merge --no-edit -s recursive -X ours origin/main
          MERGE_RC=$?
          set -e

          if [ $MERGE_RC -ne 0 ]; then
            echo "‚ö†Ô∏è Merge returned non-zero rc=${MERGE_RC}. Will create fallback branch to avoid overwriting remote unexpectedly."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please review and merge manually."
            exit 0
          fi

          if ls hltb_data/*.json 1> /dev/null 2>&1; then
            git add hltb_data/*.json
          fi
          if [ -f index111.html ]; then
            git add index111.html
          fi
          if [ -f progress.json ]; then
            git add progress.json
          fi

          if git diff --cached --quiet; then
            echo "No post-merge changes to commit"
          else
            git commit -m "${COMMIT_MSG} (post-merge)"
          fi

          set +e
          git push origin HEAD:main
          PUSH_RC=$?
          set -e

          if [ $PUSH_RC -eq 0 ]; then
            echo "‚úÖ Pushed results to main"
            exit 0
          else
            echo "‚ö†Ô∏è Push to main failed (RC=$PUSH_RC). Creating fallback branch and pushing there."
            BRANCH="hltb-worker-fallback-$(date -u +%Y%m%d%H%M%S)"
            git checkout -b "${BRANCH}"
            git push origin "${BRANCH}"
            echo "üîÄ Pushed fallback branch: ${BRANCH}. Please merge manually."
            exit 0
          fi
