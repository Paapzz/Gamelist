<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ТОП 1000</title>
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            background-color: #222;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #333;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            overflow: hidden;
            height: 30px;
        }
        #leftGroup, #rightGroup {
            display: flex;
            align-items: center;
        }
        #togglePreview, #resetButton, #inProgressButton, #filtersButton, #clearSearchButton, #resetFiltersButton, #randomButton, #importFromApiButton, #addGameButton {
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px; /* Общий отступ для большинства кнопок */
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            /* Ensure transition covers hover properties */
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease, opacity 0.3s ease;
        }
        #togglePreview {
            background-color: #4CAF50;
        }
        #togglePreview.disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }
        #resetButton {
            background-color: #f44336;
        }
        #inProgressButton {
            background-color: #ff9900;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        /* Эффект ripple для кнопки В процессе удален */
        #inProgressButton.active {
            background-color: #FFA726;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(255, 152, 0, 0.3);
            transform: scale(0.98);
        }
        #completedFilter, #hideCompletedButton {
            flex: 1;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            min-height: 43px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #hideCompletedButton {
            background-color: #2196F3;
            border: none;
            color: white;
            text-align: center;
            text-decoration: none;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
        }
        #hideCompletedButton.active {
            background-color: #1976D2;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(33, 150, 243, 0.3);
            transform: scale(0.98);
        }
        .button-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        #filtersButton {
            background-color: #4CAF50;
            margin-right: 0; /* Убираем правый отступ у кнопки Фильтры */
        }
        #clearSearchButton {
            background-color: #f44336;
            width: 24px;
            height: 24px;
            padding: 0;
            margin-left: 5px;
            font-size: 18px;
            /* line-height: 24px; */ /* Убрано, т.к. есть flexbox */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold; /* Добавлено */
        }
        #randomButton {
            background-color: #2a2a2a;
        }
        #addGameButton {
            background-color: #2196F3;
        }
        #togglePreview:hover, #resetButton:hover, #filtersButton:hover, #clearSearchButton:hover, #resetFiltersButton:hover, #randomButton:hover, #importFromApiButton:hover, #addGameButton:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }
        #inProgressButton:hover:not(.active) {
            background-color: #FFA000;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.3);
        }
        #inProgressButton.active:hover {
            background-color: #FFA726;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(255, 152, 0, 0.3);
        }
        #togglePreview:active, #resetButton:active, #filtersButton:active, #clearSearchButton:active, #resetFiltersButton:active, #randomButton:active, #importFromApiButton:active, #addGameButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #inProgressButton:active {
            background-color: #E65100;
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #customGameListButton {
            background-color: #FF9800;
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 12px;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            font-weight: normal;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            letter-spacing: 0.3px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 150px; /* Минимальная ширина */
        }

        /* Эффект ripple для кнопки Список игр удален */

        #customGameListButton:hover {
            background-color: #F57C00;
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }

        #customGameListButton:active {
            background-color: #EF6C00;
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #filtersPanel h3 { /* Центрируем кнопку внутри h3 */
             text-align: center;
             margin-bottom: 0; /* Убираем лишний отступ у h3 */
        }

        #customGameListButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #progressBarContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        #progressBarPattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right,
                black,
                violet,
                blue,
                green,
                yellow,
                orange,
                red
            );
        }
        #progressBarCover {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #333;
            transform-origin: right;
            transition: transform 0.5s;
        }
        #searchGameButton {
            background-color: #2196F3;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
             /* Add transition */
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, opacity 0.3s ease;
        }
        /* Remove old hover */
        #searchGameButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #deleteAllCustomGamesButton, #deleteAllApiGamesButton {
            margin: 10px auto;
            display: block;
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            width: 250px; /* Фиксированная ширина вместо max-width */
            text-align: center;
            white-space: nowrap;
            margin-left: auto;
            margin-right: auto;
        }
        #deleteAllCustomGamesButton:hover, #deleteAllApiGamesButton:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(244, 67, 54, 0.3);
        }
        #deleteAllCustomGamesButton:active, #deleteAllApiGamesButton:active {
            background-color: #b71c1c;
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        /* Эффект ripple для кнопок Удалить все добавленные игры удален */
        #deleteAllApiGamesButton {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
             /* Add transition */
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, opacity 0.3s ease;
        }
        /* Remove old hover */
        #deleteAllApiGamesButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #counterContainer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            padding: 3px 10px;
            z-index: 1;
            height: 24px;
            display: flex;
            align-items: center;
        }
        #counter {
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 40px 10px 50px;
        }
        .cell {
            position: relative;
            aspect-ratio: 0.75;
            cursor: pointer;
            transition: filter 0.3s, box-shadow 0.3s;
            overflow: hidden;
            border-radius: 10%;
            margin: 0;
        }
        .cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s, transform 0.2s ease;
            border-radius: 10%;
        }
        .cell.completed {
            filter: brightness(85%) !important;
        }
        .cell.completed img {
            filter: brightness(85%) !important;
        }
        .cell.completed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                linear-gradient(to top right, transparent calc(50% - 1px), red calc(50% - 1px), red calc(50% + 1px), transparent calc(50% + 1px)),
                linear-gradient(to bottom right, transparent calc(50% - 1px), red calc(50% - 1px), red calc(50% + 1px), transparent calc(50% + 1px));
            z-index: 2;
            pointer-events: none;
            filter: saturate(100%) !important;
            border-radius: 10%;
            transition: transform 0.2s ease;
        }
        .cell.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom right, transparent calc(50% - 1px), #fff, transparent calc(50% + 1px));
            pointer-events: none;
            border-radius: 10%;
            transition: transform 0.2s ease;
        }
        .cell .abbreviation-placeholder,
        .cell img,
        .cell.completed::before,
        .cell.completed::after {
            transition: transform 0.16s ease; /* Увеличена скорость анимации */
            border-radius: 10%; /* Keep border-radius consistent */
        }
        /* Remove transform from hover, handle via JS class */
        /* .cell:hover img,
        .cell:hover .abbreviation-placeholder,
        .cell.completed:hover::before,
        .cell.completed:hover::after {
            transform: scale(0.90);
        } */

        /* New class for scaling */
        .cell.scaling-out img,
        .cell.scaling-out .abbreviation-placeholder,
        .cell.completed.scaling-out::before,
        .cell.completed.scaling-out::after {
             transform: scale(0.90);
        }

        .cell.search-dimmed {
            filter: brightness(30%);
        }
        .cell.search-highlight {
            animation: highlight 5s ease-in-out infinite;
        }
        @keyframes highlight {
            0% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8); }
            100% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); }
        }
        .cell.hidden {
            display: none;
        }
        .search-match-in-progress {
            border-right: 1px solid #777; /* Тонкая серая линия */
            /* Убраны padding-right и margin-right */
            box-sizing: border-box; /* Оставляем для консистентности */
        }
        #sizeSlider {
            margin: 0;
            width: 30vw; /* Возвращаем исходную ширину */
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: linear-gradient(to right, #333, #4CAF50, #333);
            border-radius: 3px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #sizeSlider:hover {
            opacity: 1;
        }

        #sizeSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 0 0 2px #fff, 0 0 10px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        #sizeSlider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 0 0 2px #fff, 0 0 10px rgba(0, 0, 0, 0.3);
            border: none;
            transition: all 0.2s ease;
        }

        #sizeSlider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(76, 175, 80, 0.5);
        }

        #sizeSlider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(76, 175, 80, 0.5);
        }
        #sizeSliderContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 5px 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        .preview {
            position: fixed;
            display: none;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 5px;
            border-radius: 2px;
            z-index: 1001;
            pointer-events: none;
            transition: opacity 1s ease-out;
            transform: translate(0, -50%);
            top: 50%;
        }
        .preview-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .preview img {
            max-width: 65vw;
            max-height: 65vh;
            object-fit: contain;
        }
        .preview p {
            margin: 5px 0 0;
            text-align: center;
            font-size: 14px;
        }
        .game-title {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            pointer-events: none;
            display: none;
            text-align: center;
        }
        .game-title .game-year {
            display: block;
            font-size: 0.8em;
            margin-top: 2px;
        }
        #searchInput {
            margin-left: 10px;
            padding: 3px;
            font-size: 14px;
        }
        #filtersPanel {
            position: fixed;
            top: 40px;
            left: 10px;
            background-color: #333;
            padding: 15px; /* Более компактные отступы */
            border-radius: 12px;
            z-index: 1005;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3), 0 6px 12px rgba(0,0,0,0.22);
            display: none;
            max-height: calc(100vh - 50px); /* Максимальная высота с учетом верхней панели */
            overflow-y: auto;
            width: 330px; /* Увеличиваем ширину для длинных названий */
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #yearSlider {
            width: 100%;
        }
        #platformsList, #genresList {
            padding: 5px 10px;
            margin: 5px 0;
            /* Высота будет установлена динамически через JavaScript */
            min-height: calc(3em + 20px); /* Минимальная высота для 3 пунктов */
            overflow-y: auto;
            background-color: rgba(0,0,0,0.15);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
            scrollbar-width: thin;
            scrollbar-color: #4CAF50 #333;
            transition: max-height 0.3s ease;
        }



        #platformsList::-webkit-scrollbar, #genresList::-webkit-scrollbar {
            width: 6px;
        }

        #platformsList::-webkit-scrollbar-track, #genresList::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        #platformsList::-webkit-scrollbar-thumb, #genresList::-webkit-scrollbar-thumb {
            background-color: #4CAF50;
            border-radius: 3px;
        }

        #platformsList label, #genresList label {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #platformsList label:hover, #genresList label:hover {
            color: #4CAF50;
        }

        #platformsList input[type="checkbox"], #genresList input[type="checkbox"] {
            accent-color: #4CAF50;
        }
        /* Стили для контейнера ползунка выбора года */
        .year-slider-container {
            background-color: rgba(0,0,0,0.15);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .year-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .year-value-container {
            background-color: rgba(76, 175, 80, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            color: #4CAF50;
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .double-slider {
            position: relative;
            width: 100%;
            height: 40px;
            margin: 10px 0;
        }

        .double-slider input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: none;
            pointer-events: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 3;
            appearance: none;
        }

        .double-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px rgba(76, 175, 80, 0.1);
            border: none;
            z-index: 4;
            transition: all 0.2s ease;
        }

        .double-slider input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .double-slider input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px rgba(76, 175, 80, 0.1);
            border: none;
            z-index: 4;
            transition: all 0.2s ease;
        }

        .double-slider input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .slider-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 3px;
            z-index: 1;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .slider-track-highlight {
            position: absolute;
            height: 100%;
            background: linear-gradient(to right, #388E3C, #4CAF50, #81C784);
            border-radius: 3px;
            z-index: 2;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .year-slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            position: relative;
            height: 20px;
        }

        .year-slider-labels span {
            position: absolute;
            transform: translateX(-50%);
        }

        .year-slider-labels span:first-child {
            left: 0;
            transform: translateX(0);
        }

        .year-slider-labels span:last-child {
            right: 0;
            left: auto;
            transform: translateX(0);
        }

        .slider-tooltip {
            position: absolute;
            background-color: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            top: -25px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .slider-tooltip::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #4CAF50;
        }
        #filtersPanel h4 { /* Стили для заголовков фильтров */
            margin-top: 8px;
            margin-bottom: 5px;
            padding-bottom: 4px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.5);
            font-size: 1.05em;
            font-weight: 600;
            letter-spacing: 0.3px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            position: relative;
        }
        #filtersPanel h4::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 40px;
            height: 2px;
            background-color: #4CAF50; /* Акцентный зеленый цвет */
            transition: width 0.3s ease;
        }
        /* Убираем анимацию при наведении на заголовок, теперь она будет управляться через JavaScript */
        #filtersPanel h4.active::after {
            width: 100%;
        }
        /* Стили для #yearValue перенесены в .year-value-container */
        #inProgressRow {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
            background-color: #333;
            border-bottom: 1px solid #555;
            justify-content: flex-start;
            align-items: flex-start;
        }
        #inProgressRow .cell {
            flex: 0 0 auto;
            width: calc(var(--cell-size) * 1.2);
            height: calc(var(--cell-size) * 1.2 * 1.33);
            border: none;
        }
        #mainContent {
            padding-top: 1px;
        }
        .cell.completed img {
            filter: brightness(85%);
        }
        #filterButtons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            flex-wrap: wrap; /* Разрешаем перенос на новую строку */
            gap: 5px; /* Добавляем отступы между кнопками */
        }
        #filterButtons button {
            flex: 1;
            margin: 0 5px;
        }
        #resetFiltersButtonContainer {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #resetFiltersButton {
            width: 80%;
        }
        #resetFiltersButton {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #completedFilter {
            background-color: #4CAF50;
            color: white;
            border: none;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        #completedFilter, #hideCompletedButton {
            width: calc(50% - 10px);
        }
        #completedFilter {
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
            font-weight: 600;
            letter-spacing: 0.3px;
            font-size: 13px;
        }
        /* Эффект волны при нажатии */
        #completedFilter::after, #hideCompletedButton::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        #resetFiltersButton {
            padding: 8px 12px;
            width: 75%;
            margin: 15px auto 5px;
            display: block;
            font-weight: 600;
            letter-spacing: 0.3px;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
        }
        /* Эффект ripple для кнопки Сбросить фильтры удален */
        #resetFiltersButton:hover {
            background-color: #b92f2f;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #hideCompletedButton:hover:not(.active) {
            background-color: #1976D2;
            box-shadow: 0 6px 12px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }
        #hideCompletedButton.active:hover {
            background-color: #1976D2;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(33, 150, 243, 0.3);
        }
        #completedFilter:hover:not(.active) {
            background-color: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.3);
        }
        #completedFilter.active:hover {
            background-color: #2E7D32;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        #resetFiltersButton:active {
            background-color: #8a161c;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: translateY(6px);
        }

        /* Эффект ripple для кнопок Только пройденные и Скрыть пройденные удален */

        /* Анимация ripple удалена */

        #completedFilter:active {
            background-color: #2E7D32;
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #hideCompletedButton:active {
            background-color: #1565C0;
            transform: scale(0.98);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #completedFilter.active {
            background-color: #2E7D32;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 0 0 2px rgba(76, 175, 80, 0.3);
            transform: scale(0.98);
        }

        #saturationContainer {
            margin-top: 15px;
            text-align: center;
            background: rgba(0,0,0,0.15);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        #saturationContainer label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            font-size: 13px;
        }
        #saturationSlider {
            width: 100%;
            margin-top: 5px;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: linear-gradient(to right, #888, #4CAF50);
            outline: none;
            border-radius: 3px;
        }
        #saturationSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            border: 2px solid #fff;
            transition: all 0.2s ease;
        }
        #saturationSlider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        #saturationSlider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            border: 2px solid #fff;
            transition: all 0.2s ease;
        }
        #saturationSlider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        #randomButton {
            background-color: #2a2a2a;
            color: white;
            border: none;
            padding: 3px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 1;
            height: 24px;
        }
        #randomButton:hover {
            background: linear-gradient(75deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400% 400%;
            animation: rainbow 222s linear infinite;
        }
        @keyframes rainbow {
            to {
                background-position: 2000vh;
            }
        }
        .random-selected {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 65vw;
            height: 65vh;
        }
        .random-selected img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #randomSelectedContainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            max-width: 95vw;
            max-height: 95vh;
            overflow: auto;
        }
        #randomSelected {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #randomSelected img {
            max-width: 150%;
            max-height: calc(95vh - 200px);
            width: auto;
            height: auto;
            object-fit: contain;
            margin-bottom: 10px;
        }
        #randomSelected p {
            margin: 10px 0;
            font-size: 18px;
            word-wrap: break-word;
            max-width: 100%;
        }
        #topButtons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }
        #anotherRandomButton {
            display: block;
            margin: 20px auto 0;
        }
        #dontWantButton, #wantToPlayButton, #anotherRandomButton {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, opacity 0.3s ease; /* Update transition */
        }
        #dontWantButton, #wantToPlayButton {
            flex: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #dontWantButton {
            background-color: #f44336;
            color: white;
        }
        #wantToPlayButton {
            background-color: #4CAF50;
            color: white;
        }
        #anotherRandomButton {
            background-color: #FF9800;
            color: white;
            width: calc(100% - 20px);
        }
        /* Remove old hover */
        #dontWantButton:active, #wantToPlayButton:active, #anotherRandomButton:active {
            transform: scale(0.98);
        }
        .preview p {
            word-wrap: break-word;
            max-width: 100%;
        }
        #mainContent {
            padding-top: 40px;
        }
        #grid {
            padding-top: 5px;
        }
        .square-button {
            width: 24px;
            height: 24px;
            padding: 0;
            /* margin-left: 5px; */ /* Убрано отсюда */
            font-size: 18px;
            line-height: 24px;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
             /* Add transition */
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, opacity 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        #resetFiltersButtonHeader { /* Явный стиль для кнопки сброса фильтров */
             margin-left: 5px; /* Гарантируем отступ здесь */
        }
        #clearSearchButton, #resetFiltersButtonHeader {
            background-color: #f44336;
            color: white;
        }
        /* Remove old hover */
        #clearSearchButton:active, #resetFiltersButtonHeader:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .cell.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom right, transparent calc(50% - 1px), #fff, transparent calc(50% + 1px));
            pointer-events: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #333;
            margin: 3% auto;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3), 0 6px 12px rgba(0,0,0,0.22);
            max-height: calc(95vh - 40px);
            overflow-y: auto;
            bottom: 15vh;
            backdrop-filter: blur(5px);
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .button-container button {
            width: 48%;
            padding: 10px;
            font-size: 14px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, color 0.3s ease; /* Add transition */
        }
        /* Remove old hover */
        .close:focus {
            color: #fff;
        }
        #searchResults {
            position: relative;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            scrollbar-width: thin; /* Для Firefox */
            scrollbar-color: #4CAF50 rgba(0,0,0,0.2); /* Для Firefox: цвет ползунка и фона */
        }

        #searchResults::-webkit-scrollbar {
            width: 6px;
        }

        #searchResults::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        #searchResults::-webkit-scrollbar-thumb {
            background-color: #4CAF50; /* Зеленый цвет для ползунка */
            border-radius: 3px;
        }

        #searchResults::-webkit-scrollbar-thumb:hover {
            background-color: #3d8b40; /* Более темный зеленый при наведении */
        }
        .search-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            filter: saturate(100%) !important;
        }
        .search-result button {
            margin-left: 10px;
        }
        #searchResults .cell {
            filter: saturate(100%) !important;
        }
        .cell.search-match {
            filter: saturate(100%) !important;
        }
        .message-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 18px;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 9998;
            pointer-events: none;
        }

        #addGameForm {
            display: flex;
            flex-direction: column;
        }
        #addGameForm input {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        #addGameForm input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        #addGameForm label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        #addGameForm button,
        #cancelAddGame {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, opacity 0.3s ease; /* Update transition */
        }
        #addGameForm button {
            background-color: #4CAF50;
            color: white;
        }
        #cancelAddGame {
            background-color: #f44336;
            color: white;
        }
        /* Remove old hover */
        #addGameForm button:active,
        #cancelAddGame:active {
            transform: translateY(0);
        }
        .abbreviation-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            word-break: break-word;
            padding: 5%;
            box-sizing: border-box;
        }
        .custom-game .abbreviation-placeholder {
            background-color: #1a1a1a;
        }
        .preview .abbreviation-placeholder {
            width: 200px;
            height: 300px;
            font-size: 24px;
            background-color: #333;
        }
        .custom-game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px 12px;
            background-color: rgba(0,0,0,0.15);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .custom-game-item:hover {
            background-color: rgba(0,0,0,0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .custom-game-item button {
            margin-left: 10px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        .custom-game-item .delete-game {
            background-color: #f44336;
            color: white;
        }
        /* Эффект ripple для кнопок в списке игр удален */
        .custom-game-item .delete-game:hover { /* Keep background hover */
            background-color: #d32f2f;
        }
        .delete-game {
            background-color: #f44336;
            color: white;
        }
        .required-fields {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
        .input-with-button {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .input-with-button .input-button-wrapper {
            display: flex;
            align-items: center;
        }
        .input-with-button input {
            flex-grow: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }
        .input-with-button button {
            padding: 8px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; /* Update transition */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }
        .input-with-button button:hover { /* Keep background hover */
            background-color: #1976D2;
        }
        .input-with-button button:active {
            background-color: #0D47A1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        #importFromApiModalButton, #searchGameModalButton {
            width: 48%;
            font-size: 14px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; /* Add transition */
        }
        #buttonContainer {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #searchInputContainer {
            display: block;
            margin-top: 10px;
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }

        .clear-input-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #f44336;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            display: none;
        }

        .clear-input-button:hover {
            background-color: #d32f2f;
        }

        #performSearchButton {
            display: block;
            width: 60%;
            margin: 0 auto 15px;
            padding: 10px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #performSearchButton:hover {
            background-color: #1976D2;
        }
        #searchResults {
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .search-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Увеличиваем отступ снизу */
            padding: 8px 10px; /* Увеличиваем внутренние отступы */
            border-radius: 6px;
            transition: all 0.2s ease;
            background-color: rgba(0, 0, 0, 0.1); /* Легкий фон для каждой строки */
            border-left: 3px solid rgba(76, 175, 80, 0.5); /* Зеленая полоса слева */
        }

        /* Добавляем легкое и минималистичное выделение всей строки при наведении */
        .search-result:hover {
            background-color: rgba(76, 175, 80, 0.15); /* Более заметный фон при наведении */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            border-left: 3px solid #4CAF50; /* Более яркая полоса при наведении */
            transform: translateX(2px); /* Небольшое смещение вправо при наведении */
        }

        /* Стили для информации об игре */
        .game-info {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-right: 10px;
        }

        .game-name {
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 2px;
            color: #fff;
        }

        .game-year {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Стиль для сообщения "Игры не найдены" */
        .no-games-found {
            text-align: center;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 15px;
            margin: 10px 0;
            border-left: 3px solid #f44336; /* Красная полоса слева */
        }

        /* Стиль для сообщения об ошибке при поиске */
        .search-error {
            text-align: center;
            padding: 15px;
            background-color: rgba(244, 67, 54, 0.1); /* Легкий красный фон */
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            margin: 10px 0;
            border-left: 3px solid #f44336; /* Красная полоса слева */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .add-game-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; /* Add transition */
            /* Уменьшаем кнопку на 5% */
            transform: scale(0.95);
            border-radius: 4px;
        }
        #optionsList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        #optionsList label {
            display: block;
            margin-bottom: 5px;
        }
        #applyOptionsBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease; /* Add transition */
        }
        #customGameSearchInput {
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background-color: rgba(0,0,0,0.2);
            color: white;
            font-size: 14px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            box-sizing: border-box; /* Чтобы padding включался в ширину */
        }
        #customGameSearchInput:focus {
            outline: none;
            border-color: rgba(76, 175, 80, 0.5);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2), inset 0 1px 3px rgba(0,0,0,0.2);
        }
        #customGameList {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 15px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
            scrollbar-width: thin; /* Для Firefox */
            scrollbar-color: #f44336 rgba(0,0,0,0.2); /* Для Firefox: цвет ползунка и фона */
        }
        #customGameList::-webkit-scrollbar {
            width: 6px;
        }
        #customGameList::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        #customGameList::-webkit-scrollbar-thumb {
            background-color: #f44336; /* Красный цвет для ползунка */
            border-radius: 3px;
        }
        #customGameList::-webkit-scrollbar-thumb:hover {
            background-color: #d32f2f; /* Более темный красный при наведении */
        }
        .abbreviation-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            word-break: break-word;
            padding: 5%;
            box-sizing: border-box;
        }
        .preview .abbreviation-placeholder,
        #randomSelected .abbreviation-placeholder {
            width: 200px;
            height: 300px;
            font-size: 24px;
            background-color: #333;
        }
        .saturated {
            transition: filter 0.3s ease;
        }
        .in-progress img {
            filter: saturate(100%) !important;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            pointer-events: none;
        }

        .loading-message {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px 40px;
            border-radius: 40px;
            font-size: 24px;
            text-align: center;
        }

        /* --- NEW General Hover Effect --- */
        /* Place this rule towards the end to help override specifics */
        button:hover,
        .close:hover,
        .delete-game:hover
        {
            /* Exclude buttons with specific active/disabled states or unique hovers */
            &:not(.active):not(.disabled):not(#randomButton):not(.button-disabled) {
                 transform: scale(1.05);
                 filter: brightness(1.1);
                 box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }
        }

        /* Отдельный стиль для кнопки "Добавить", чтобы учесть уменьшенный размер */
        .add-game-button:hover {
            transform: scale(1.0); /* Возвращаем к нормальному размеру при наведении */
            filter: brightness(1.1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Keep specific background/color/opacity hovers if needed */
         #completedFilter:hover:not(.active) { background-color: #16831b; }
         #resetFiltersButton:hover { background-color: #b92f2f; }
         #hideCompletedButton:hover:not(.active) { background-color: #1976D2; }
         .custom-game-item .delete-game:hover { background-color: #d32f2f; }
         .input-with-button button:hover { background-color: #1976D2; }
         #closeSearchResults:hover { background-color: #d32f2f; }
         .close:hover { color: #fff; }
         #dontWantButton:hover, #wantToPlayButton:hover, #anotherRandomButton:hover { opacity: 0.9; }
         /* Убрано для кнопки Список игр */
         #searchGameButton:hover { opacity: 0.9; }
         #deleteAllApiGamesButton:hover { opacity: 0.9; }
         #clearSearchButton:hover, #resetFiltersButtonHeader:hover { opacity: 0.9; }
         #addGameForm button:hover, #cancelAddGame:hover { opacity: 0.9; }

    </style>
</head>
<body>
    <div id="header">
        <div id="progressBarContainer">
            <div id="progressBarPattern"></div>
            <div id="progressBarCover"></div>
            <button id="searchGameButton">Найти игру</button>
        </div>
        <div id="leftGroup">
            <button id="togglePreview">Превью</button>
            <input type="text" id="searchInput" placeholder="Поиск игры...">
            <button id="clearSearchButton">×</button>
            <button id="filtersButton">Фильтры</button>
            <button id="resetFiltersButtonHeader" class="square-button">×</button>
        </div>
        <div id="counterContainer">
            <div id="counter">Пройдено: 0 из 0</div>
        </div>
        <div id="rightGroup">
            <button id="randomButton">Random</button>
            <button id="inProgressButton">В процессе</button>
            <button id="addGameButton">Добавить игру</button>
            <button id="resetButton">Сброс</button>
        </div>
    </div>
    <div id="mainContent">
        <div id="inProgressRow"></div>
        <div id="grid"></div>
    <div id="sizeSliderContainer">
        <input type="range" id="sizeSlider" min="25" max="250" value="50" step="1">
    </div>
    <div class="preview" id="preview">
        <div class="preview-content">
            <img src="" alt="">
            <p></p>
        </div>
    </div>
    <div class="game-title" id="gameTitle"></div>
    <div id="filtersPanel">

        <div class="year-slider-container">
            <div class="year-slider-header">
                <label for="yearSlider">Год выпуска:</label>
                <div class="year-value-container">
                    <span id="yearValue"></span>
                </div>
            </div>
            <div class="double-slider">
                <div class="slider-track">
                    <div class="slider-track-highlight"></div>
                </div>
                <input type="range" id="yearSliderMin" min="1971" max="2023" value="1971">
                <input type="range" id="yearSliderMax" min="1972" max="2023" value="2024">
                <div class="slider-tooltip min-tooltip"></div>
                <div class="slider-tooltip max-tooltip"></div>
            </div>
            <div class="year-slider-labels">
                <span id="minYearLabel"></span>
                <span id="maxYearLabel"></span>
            </div>
        </div>
        <h4>Платформы:</h4>
        <div id="platformsList"></div>
        <h4>Жанры:</h4>
        <div id="genresList"></div>
        <div id="filterButtons" style="margin-top: 15px;">
            <button id="completedFilter">Только<br>пройденные</button>
            <button id="hideCompletedButton">Скрыть пройденные</button>
        </div>
        <div style="text-align: center; margin: 10px 0;">
            <button id="customGameListButton" style="transform: scale(1.1);">Список игр</button>
        </div>
        <div style="text-align: center; margin-bottom: 10px;">
            <button id="resetFiltersButton">Сбросить фильтры</button>
        </div>
        <div id="saturationContainer">
            <label for="saturationSlider">Насыщенность</label>
            <input type="range" id="saturationSlider" min="0" max="100" value="100">
        </div>
    </div>
    <div id="randomSelectedContainer">
        <div id="randomSelected"></div>
        <div id="topButtons">
            <button id="dontWantButton">Не хочу</button>
            <button id="wantToPlayButton">Хочу пройти!</button>
        </div>
        <button id="anotherRandomButton">давай другую</button>
    </div>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-message">Загружается, подождите...</div>
    </div>
    <div id="addGameModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить игры</h2>
            <form id="addGameForm">
                <div id="buttonContainer">
                    <button type="button" id="importFromApiModalButton">Добавить 100 игр</button>
                    <button type="button" id="searchGameModalButton">Добавить 10 игр</button>
                </div>
                <div id="searchInputContainer" style="display: none;">
                    <div class="search-input-wrapper">
                        <input type="text" id="searchGameInput" placeholder="Введите название игры">
                        <button type="button" id="clearSearchInputButton" class="clear-input-button">×</button>
                    </div>
                    <button type="button" id="performSearchButton">Поиск</button>
                </div>
                <div id="searchResults"></div>
            </form>
        </div>
    </div>
    <div id="selectOptionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="selectOptionsTitle"></h2>
            <div id="optionsList"></div>
            <button id="applyOptionsBtn">Применить</button>
        </div>
    </div>
    <div id="customGameListModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Список игр</h2>
            <input type="text" id="customGameSearchInput" placeholder="Поиск...">
            <div id="customGameList"></div>
            <div style="text-align: center;">
                <button id="deleteAllApiGamesButton">Удалить все добавленные игры</button>
            </div>
        </div>
    </div>

    <script>
        console.log('Скрипт начал выполнение');
        const mainContent = document.getElementById('mainContent');
        const grid = document.getElementById('grid');
        const counter = document.getElementById('counter');
        const sizeSlider = document.getElementById('sizeSlider');
        const preview = document.getElementById('preview');
        const togglePreviewBtn = document.getElementById('togglePreview');
        const resetButton = document.getElementById('resetButton');
        const hideCompletedButton = document.getElementById('hideCompletedButton');
        const inProgressButton = document.getElementById('inProgressButton');
        const gameTitle = document.getElementById('gameTitle');
        const progressBarCover = document.getElementById('progressBarCover');
        const searchInput = document.getElementById('searchInput');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const filtersButton = document.getElementById('filtersButton');
        const filtersPanel = document.getElementById('filtersPanel');
        const yearSliderMin = document.getElementById('yearSliderMin');
        const yearSliderMax = document.getElementById('yearSliderMax');
        const yearValue = document.getElementById('yearValue');
        const platformsList = document.getElementById('platformsList');
        const genresList = document.getElementById('genresList');
        const resetFiltersButton = document.getElementById('resetFiltersButton');
        const completedFilter = document.getElementById('completedFilter');
        const randomButton = document.getElementById('randomButton');
        const saturationSlider = document.getElementById('saturationSlider');
        const inProgressRow = document.getElementById('inProgressRow');
        const authorCredit = document.getElementById('authorCredit');
        const searchGameModalButton = document.getElementById('searchGameModalButton');
        const searchInputContainer = document.getElementById('searchInputContainer');
        const searchGameInput = document.getElementById('searchGameInput');
        const performSearchButton = document.getElementById('performSearchButton');
        const searchResults = document.getElementById('searchResults');
        let authorCreditTimeout;
        let completedGames = 0;
        let games = [];
        let previewTimeout;
        let previewEnabled = localStorage.getItem('previewEnabled') !== 'false';
        let inProgressMode = false;
        let hideCompleted = JSON.parse(localStorage.getItem('hideCompleted')) || false;

        let savedMinYear = localStorage.getItem('minYear');
        let savedMaxYear = localStorage.getItem('maxYear');
        let selectedPlatforms = JSON.parse(localStorage.getItem('selectedPlatforms')) || [];
        let selectedGenres = JSON.parse(localStorage.getItem('selectedGenres')) || [];
        const gamesList = [
        {"number":1,"title":"the-legend-of-zelda-breath-of-the-wild","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co3p2d.jpg","year":2017,"genres":["Action","Adventure","Open world","Puzzle","Role-playing (RPG)","Sandbox","Survival"],"platforms":["Nintendo Switch","Nintendo Wii U"]},
{"number":2,"title":"the-last-of-us","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co1r7f.jpg","year":2013,"genres":["Action","Adventure","Horror","Shooter","Stealth","Survival"],"platforms":["PlayStation 3","PlayStation 4"]},
{"number":3,"title":"tetris--4","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co6n9j.jpg","year":1985,"genres":["Arcade","Puzzle"],"platforms":["DOS","Electronika 60","Game Boy","Nintendo Entertainment System"]},
{"number":4,"title":"half-life-2","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co1nmw.jpg","year":2004,"genres":["Action","Horror","Shooter"],"platforms":["Windows PC"]},
{"number":1000,"title":"wizardry-crusaders-of-the-dark-savant","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co2kkd.jpg","year":1992,"genres":["Adventure","Role-playing (RPG)"],"platforms":["Apple Macintosh","DOS","FM Towns","PC-9800","PlayStation","Windows PC"]}
        ];

        games = gamesList.map(game => ({
            id: game.number,
            name: game.title.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            imageUrl: game.image_url,
            year: game.year,
            genres: game.genres,
            platforms: game.platforms,
            completed: false,
            inProgress: false,
            isCustom: false
        }));

        function loadSavedGames() {
            const savedGames = localStorage.getItem('games');
            if (savedGames) {
                games = JSON.parse(savedGames);
                completedGames = games.filter(game => game.completed).length;
                updateInProgressRow();
            }
        }

        function saveGames() {
            localStorage.setItem('games', JSON.stringify(games));
        }

        function updateCounter() {
            const totalGames = games.length;
            const completedGames = games.filter(game => game.completed).length;
            counter.textContent = `Пройдено: ${completedGames} из ${games.length}`;
	        updateProgressBar();
        }

        function updateProgressBar() {
            const progress = completedGames / games.length;
            progressBarCover.style.transform = `scaleX(${1 - progress})`;
        }

        function toggleCell(cell, gameId) {
            if (!gameId) {
                return;
            }

            const game = games.find(g => g.id && g.id.toString() === gameId.toString());
            if (!game) {
                return;
            }

            if (inProgressMode) {
                if (!game.inProgress && !game.completed) {
                    game.inProgress = true;
                    game.completed = false;
                } else if (game.inProgress) {
                    game.inProgress = false;
                    game.completed = false;
                } else if (game.completed) {
                    game.inProgress = true;
                    game.completed = false;
                }
            } else {
                if (!game.completed && !game.inProgress) {
                    game.completed = true;
                    game.inProgress = false;
                    completedGames++;
                } else if (game.completed) {
                    game.completed = false;
                    game.inProgress = false;
                    completedGames--;
                } else if (game.inProgress) {
                    game.completed = true;
                    game.inProgress = false;
                    completedGames++;
                }
            }
            updateSaturation();

            cell.classList.remove('completed', 'in-progress');
            if (game.completed) {
                cell.classList.add('completed');
            } else if (game.inProgress) {
                cell.classList.add('in-progress');
            }

            if (game.inProgress) {
                if (cell.parentElement !== inProgressRow) {
                    grid.removeChild(cell);
                    inProgressRow.appendChild(cell);
                }
            } else {
                if (cell.parentElement === inProgressRow) {
                    inProgressRow.removeChild(cell);
                    insertCellInOrder(cell);
                }
            }

            if (game.completed) {
                cell.classList.add('completed');
            } else if (game.inProgress) {
                cell.classList.add('in-progress');
            }

            updateCellSize(cell, game.inProgress);

            // Добавляем или удаляем класс hidden в зависимости от состояния hideCompleted и статуса игры
            cell.classList.toggle('hidden', hideCompleted && game.completed);

            if (game.inProgress) {
                cell.classList.add('in-progress');
            } else {
                cell.classList.remove('in-progress');
            }

            updateSaturation();
            saveGames();
            hidePreviewAndTitle();
            updateCounter();
            updateInProgressRow();
            applyFilters();
        }

        // Функция для сортировки игр по году (игры без года в конце)
        function sortGamesByYear(gamesArray) {
            // Проверяем, установлены ли в фильтрах конкретные значения минимального и максимального года
            const years = [...new Set(games.filter(game => game.year !== null).map(game => game.year))].sort((a, b) => a - b);
            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);

            // Проверяем, изменены ли ползунки из их стандартного положения
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);

            // Фильтр считается активным, если пользователь изменил ползунки
            // И они не находятся на минимальном и максимальном значениях
            const isYearFilterActive = minVal > minGameYear || maxVal < maxGameYear;

            // Если пользователь изменил ползунки, сортируем игры по году (игры без года в конце)
            if (isYearFilterActive) {
                return [...gamesArray].sort((a, b) => {
                    // Если обе игры имеют год, сортируем по возрастанию
                    if (a.year !== null && b.year !== null) {
                        return a.year - b.year;
                    }
                    // Если только у первой игры нет года, она идет в конец
                    if (a.year === null && b.year !== null) {
                        return 1;
                    }
                    // Если только у второй игры нет года, она идет в конец
                    if (a.year !== null && b.year === null) {
                        return -1;
                    }
                    // Если у обеих игр нет года, сортируем по ID
                    return a.id - b.id;
                });
            }

            // Если пользователь не изменил ползунки, сортируем по ID
            return [...gamesArray].sort((a, b) => a.id - b.id);
        }

        function renderGames(forceIdSort = false) {
            grid.innerHTML = '';
            inProgressRow.innerHTML = '';
            let renderedCells = 0;

            // Проверяем, активен ли фильтр по годам
            const years = [...new Set(games.filter(game => game.year !== null).map(game => game.year))].sort((a, b) => a - b);
            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);

            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);

            // Фильтр считается активным, если пользователь изменил ползунки
            const isYearFilterActive = minVal > minGameYear || maxVal < maxGameYear;

            // Сортируем игры перед отображением
            let sortedGames;

            if (isYearFilterActive && !forceIdSort) {
                // Если фильтр по годам активен, сортируем по году (игры без года в конец)
                sortedGames = [...games].sort((a, b) => {
                    // Если обе игры имеют год, сортируем по возрастанию
                    if (a.year !== null && b.year !== null) {
                        return a.year - b.year;
                    }
                    // Если только у первой игры нет года, она идет в конец
                    if (a.year === null && b.year !== null) {
                        return 1;
                    }
                    // Если только у второй игры нет года, она идет в конец
                    if (a.year !== null && b.year === null) {
                        return -1;
                    }
                    // Если у обеих игр нет года, сортируем по ID
                    return a.id - b.id;
                });
            } else {
                // Если фильтр по годам не активен или указан параметр forceIdSort, сортируем по ID
                sortedGames = [...games].sort((a, b) => a.id - b.id);
            }

            sortedGames.forEach(game => {
                const cell = createCell(game);
                if (game.inProgress) {
                    inProgressRow.appendChild(cell);
                } else {
                    grid.appendChild(cell);
                }
                renderedCells++;
            });
            updateInProgressRow();
            // applyFilters(); // <-- Убираем этот вызов
        }

        function insertCellInOrder(cell) {
            const gameId = parseInt(cell.dataset.gameId);
            const game = games.find(g => g.id.toString() === gameId.toString());
            const cells = Array.from(grid.children);

            // Проверяем, установлены ли в фильтрах конкретные значения минимального и максимального года
            const years = [...new Set(games.filter(g => g.year !== null).map(g => g.year))].sort((a, b) => a - b);
            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);

            // Проверяем, изменены ли ползунки из их стандартного положения
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);

            // Фильтр считается активным, если пользователь изменил ползунки
            const isYearFilterActive = minVal > minGameYear || maxVal < maxGameYear;

            if (isYearFilterActive && game && game.year !== null) {
                // Если фильтр по годам активен и у игры есть год, ищем позицию по году
                let insertIndex = -1;

                for (let i = 0; i < cells.length; i++) {
                    const cellId = parseInt(cells[i].dataset.gameId);
                    const cellGame = games.find(g => g.id.toString() === cellId.toString());

                    if (!cellGame) continue;

                    // Если у текущей игры в сетке нет года, то вставляем перед ней
                    if (cellGame.year === null) {
                        insertIndex = i;
                        break;
                    }

                    // Если год текущей игры в сетке больше года добавляемой игры, вставляем перед ней
                    if (cellGame.year > game.year) {
                        insertIndex = i;
                        break;
                    }
                }

                if (insertIndex === -1) {
                    grid.appendChild(cell);
                } else {
                    grid.insertBefore(cell, cells[insertIndex]);
                }
            } else if (isYearFilterActive && game && game.year === null) {
                // Если фильтр по годам активен и у игры нет года, добавляем в конец
                grid.appendChild(cell);
            } else {
                // Если фильтр по годам не активен, используем сортировку по ID
                const insertIndex = cells.findIndex(c => parseInt(c.dataset.gameId) > gameId);

                if (insertIndex === -1) {
                    grid.appendChild(cell);
                } else {
                    grid.insertBefore(cell, cells[insertIndex]);
                }
            }
        }

        async function searchGameFromApi() {
            const gameName = searchGameInput.value.trim();
            if (!gameName) {
                showMessage('Введите название');
                return;
            }

            showLoadingMessage();
            try {
                const indexResponse = await fetch('data/index.json');
                if (!indexResponse.ok) {
                    throw new Error(`Ошибка загрузки индекса: ${indexResponse.status} ${indexResponse.statusText}`);
                }
                const index = await indexResponse.json();

                let matchedGames = [];
                for (let i = 1; i <= index.total_files; i++) {
                    const response = await fetch(`data/games_${i}.json`);
                    if (!response.ok) {
                        throw new Error(`Ошибка загрузки файла games_${i}.json: ${response.status} ${response.statusText}`);
                    }
                    const fileGames = await response.json();
                    const matches = fileGames.filter(game =>
                        game.name.toLowerCase().includes(gameName.toLowerCase())
                    );
                    matchedGames = matchedGames.concat(matches);
                    if (matchedGames.length >= 30) {
                        break;
                    }
                }

                matchedGames = matchedGames.slice(0, 30);
                displaySearchResults(matchedGames);
            } catch (error) {
                console.error('Ошибка при поиске игры:', error);
                searchResults.innerHTML = '<p class="search-error">Ошибка при поиске игры. Пожалуйста, попробуйте еще раз.</p>';
            } finally {
                hideLoadingMessage();
            }
        }

        function displaySearchResults(games) {
            searchResults.innerHTML = '';
            if (games.length === 0) {
                searchResults.innerHTML = '<p class="no-games-found">Игры не найдены.</p>';
                return;
            }

            const uniqueGames = games.filter((game, index, self) =>
                index === self.findIndex((t) => t.id === game.id)
            );

            uniqueGames.forEach(game => {
                const resultElement = document.createElement('div');
                resultElement.className = 'search-result';
                const releaseYear = game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : 'N/A';
                resultElement.innerHTML = `
                    <div class="game-info">
                        <span class="game-name">${game.name}</span>
                        <span class="game-year">(${releaseYear})</span>
                    </div>
                    <button type="button" class="add-game-button">Добавить</button>
                `;
                resultElement.querySelector('.add-game-button').addEventListener('click', () => addGameFromSearch(game));

                // Добавляем анимацию плавного появления
                resultElement.style.opacity = '0';
                resultElement.style.transform = 'translateY(10px)';
                searchResults.appendChild(resultElement);

                // Запускаем анимацию с небольшой задержкой для каждого элемента
                setTimeout(() => {
                    resultElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    resultElement.style.opacity = '1';
                    resultElement.style.transform = 'translateY(0)';
                }, 50 * uniqueGames.indexOf(game)); // Задержка зависит от порядкового номера элемента
            });
            // Удалено, так как кнопка "Очистить" была удалена
        }

        performSearchButton.addEventListener('click', () => {
                console.log('Выполняется поиск игры:', searchGameInput.value);
            });

        function updateInProgressRow() {
            inProgressRow.innerHTML = '';
            const inProgressGames = games.filter(game => game.inProgress);
            inProgressGames.forEach(game => {
                const cell = createCell(game);
                inProgressRow.appendChild(cell);
            });

            if (inProgressRow.children.length > 0) {
                inProgressRow.style.display = 'flex';
            } else {
                inProgressRow.style.display = 'none';
            }

            const size = sizeSlider.value;
            inProgressRow.querySelectorAll('.cell').forEach(cell => {
                updateCellSize(cell, true);
            });
        }

        function addGameFromSearch(game) {
            const newGame = {
                id: Date.now(),
                name: game.name,
                year: game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : null,
                genres: game.genres ? game.genres.map(g => g.name) : [],
                platforms: game.platforms ? game.platforms.map(p => getPlatformName(p.id)).filter(p => p !== null && p !== "") : [],
                imageUrl: game.cover ? convertImageUrl(game.cover.url) : '',
                isCustom: true,
                importedFromApi: true,
                completed: false,
                inProgress: false
            };

            if (!isDuplicateGame(newGame)) {
                addNewGame(newGame);
                saveGames();
                showMessage('Игра успешно добавлена!');
            } else {
                showMessage('Эта игра уже есть в вашем списке.');
            }
        }

        function getPlatformName(platformId) {
            const platformMap = {
                6: "PC (Microsoft Windows)",
                167: "PlayStation 5",
                169: "Xbox Series X|S",
                130: "Nintendo Switch",
                48: "PlayStation 4",
                49: "Xbox One",
                41: "Wii U",
                9: "PlayStation 3",
                12: "Xbox 360",
                5: "Wii",
                37: "Nintendo 3DS",
                46: "PlayStation Vita",
                8: "PlayStation 2",
                11: "Xbox",
                20: "Nintendo DS",
                7: "PlayStation",
                14: "GameCube",
                3: "Linux",
                162: "Oculus VR",
                165: "PlayStation VR"
            };
            return platformMap[platformId] || null;
        }

        function showMessage(message) {
            const existingMessage = document.querySelector('.message-overlay');
            if (existingMessage) {
                existingMessage.remove();
                clearTimeout(messageTimeout);
            }

            const overlay = document.createElement('div');
            overlay.className = 'message-overlay';
            overlay.textContent = message;
            document.body.appendChild(overlay);

            messageTimeout = setTimeout(() => {
                overlay.remove();
            }, 3000);
        }

        function closeAddGameModal() {
            addGameModal.style.display = 'none';
            searchGameInput.value = '';
            searchResults.innerHTML = '';
            // Удалено, так как кнопка "Очистить" была удалена
        }

        function getRandomPastelColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 10;
            const lightness = 60 + Math.random() * 10;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function showPreviewOrTitle(e, game) {
            if (game.completed) {
                showGameTitle(e, game);
            } else if (previewEnabled) {
                showPreview(e, game);
            } else {
                showGameTitle(e, game);
            }
        }

        function showPreview(e, game) {
            clearTimeout(previewTimeout);
            preview.style.opacity = '1';
            preview.style.display = 'block';
            const img = preview.querySelector('img');
            const abbreviationPlaceholder = preview.querySelector('.abbreviation-placeholder') || document.createElement('div');
            abbreviationPlaceholder.className = 'abbreviation-placeholder';

            if (game.imageUrl) {
                img.src = game.imageUrl;
                img.style.display = 'block';
                abbreviationPlaceholder.style.display = 'none';
            } else {
                img.style.display = 'none';
                abbreviationPlaceholder.innerHTML = `<span style="color: ${game.color};">${game.name}</span>`;
                abbreviationPlaceholder.style.display = 'flex';
                preview.querySelector('.preview-content').appendChild(abbreviationPlaceholder);
            }

            const updatePreviewPosition = () => {
                const previewRect = preview.getBoundingClientRect();
                const margin = window.innerWidth * 0.05;

                let currentSide = preview.style.right === 'auto' ? 'left' : 'right';

                if (currentSide === 'left' && e.clientX < previewRect.right + margin) {
                    currentSide = 'right';
                } else if (currentSide === 'right' && e.clientX > previewRect.left - margin) {
                    currentSide = 'left';
                }

                if (currentSide === 'left') {
                    preview.style.left = '5%';
                    preview.style.right = 'auto';
                } else {
                    preview.style.left = 'auto';
                    preview.style.right = '5%';
                }
            };

            if (game.imageUrl) {
                img.onload = () => {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const maxWidth = window.innerWidth * 0.65;
                    const maxHeight = window.innerHeight * 0.645;
                    let width = maxWidth;
                    let height = width / aspectRatio;
                    if (height > maxHeight) {
                        height = maxHeight;
                        width = height * aspectRatio;
                    }
                    img.style.width = `${width}px`;
                    img.style.height = `${height}px`;

                    updatePreviewPosition();
                };
            } else {
                abbreviationPlaceholder.style.width = '200px';
                abbreviationPlaceholder.style.height = '300px';
                updatePreviewPosition();
            }

            const yearText = game.year ? ` (${game.year})` : ' (N/A)';
            preview.querySelector('p').textContent = `${game.name}${yearText}`;
            startPreviewTimeout();
        }

        function showGameTitle(e, game) {
            gameTitle.innerHTML = `${game.name}<span class="game-year">${game.year ? `(${game.year})` : '(N/A)'}</span>`;
            gameTitle.style.display = 'block';

            const titleRect = gameTitle.getBoundingClientRect();
            const left = e.clientX - titleRect.width / 2;
            const top = e.clientY - titleRect.height - 10;

            gameTitle.style.left = `${Math.max(0, Math.min(left, window.innerWidth - titleRect.width))}px`;
            gameTitle.style.top = `${Math.max(0, top)}px`;
        }

        function updateGameInfoPosition(e, game) {
            if (previewEnabled) {
            } else {
                showGameTitle(e, game);
            }
        }

        function startPreviewTimeout() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                preview.style.opacity = '0';
                setTimeout(() => {
                    if (preview.style.opacity === '0') {
                        preview.style.display = 'none';
                    }
                }, 1000);
            }, 3000);
        }

        function hidePreviewAndTitle() {
            hidePreview();
            hideGameTitle();
        }

        function hidePreview() {
            clearTimeout(previewTimeout);
            preview.style.opacity = '0';
            setTimeout(() => {
                if (preview.style.opacity === '0') {
                    preview.style.display = 'none';
                }
            }, 1000);
        }

        function hideGameTitle() {
            gameTitle.style.display = 'none';
        }

        function updateGridSize() {
            const size = sizeSlider.value;
            document.documentElement.style.setProperty('--cell-size', `${size}px`);
            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${size}px, 1fr))`;
            localStorage.setItem('gridSize', size);

            updateAllCellSizes();

            // Вызываем updateInProgressRow() только если ползунок не в движении
            if (!sizeSliderMoving) {
                updateInProgressRow();
            }

            void grid.offsetHeight;
            // Убираем вызов applyFilters() отсюда, так как он теперь в обработчике события change
        }

        function lazyLoadImages() {
            const images = document.querySelectorAll('img[data-src]');
            if (!images.length) return;

            const visibleImages = new Set();

            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImage(img);
                        observer.unobserve(img);
                    } else {
                        visibleImages.add(entry.target);
                    }
                });

                const remainingImages = document.querySelectorAll('img[data-src]');
                if (remainingImages.length === 0) {
                    observer.disconnect();
                }
            });

            images.forEach(img => {
                observer.observe(img);
            });
        }

        function loadImage(img) {
            img.src = img.dataset.src;
            img.removeAttribute('data-src');
        }

        function loadRemainingImages() {
            const remainingImages = document.querySelectorAll('img[data-src]');
            remainingImages.forEach(img => {
                loadImage(img);
            });
        }

        function saveGamesToCache() {
            localStorage.setItem('games', JSON.stringify(games));
        }

        function loadGamesFromCache() {
            const cachedGames = localStorage.getItem('games');
            if (cachedGames) {
                games = JSON.parse(cachedGames);
            }
        }

        function initializeCacheClearing() {
            const CACHE_DURATION = 30 * 24 * 60 * 60 * 1000; // 30 дней
            const lastClearTime = localStorage.getItem('lastCacheClear');
            const currentTime = Date.now();

            if (!lastClearTime) {
                localStorage.setItem('lastCacheClear', currentTime.toString());
            } else if ((currentTime - parseInt(lastClearTime)) >= CACHE_DURATION) {
                clearCache();
                localStorage.setItem('lastCacheClear', currentTime.toString());
            }

            setInterval(() => {
                const now = Date.now();
                const lastClear = localStorage.getItem('lastCacheClear');
                if ((now - parseInt(lastClear)) >= CACHE_DURATION) {
                    clearCache();
                    localStorage.setItem('lastCacheClear', now.toString());
                }
            }, CACHE_DURATION);
        }

        function clearCache() {
            try {
                const games = localStorage.getItem('games');
                if (games) {
                    localStorage.removeItem('games');
                    console.log('Кэш игр очищен');
                }
            } catch (e) {
                console.error('Ошибка при очистке кэша:', e);
            }
        }

        function updateAllCellSizes() {
            const size = sizeSlider.value;
            document.querySelectorAll('.cell').forEach(cell => {
                const isInProgress = cell.classList.contains('in-progress');
                updateCellSize(cell, isInProgress);
            });
        }

        function updateCellSize(cell, isInProgress) {
            const size = sizeSlider.value;
            if (isInProgress) {
                cell.style.width = `${size * 1.2}px`;
                cell.style.height = `${size * 1.2 * 1.33}px`;
            } else {
                cell.style.width = `${size}px`;
                cell.style.height = `${size * 1.33}px`;
            }

            const abbreviationPlaceholder = cell.querySelector('.abbreviation-placeholder');
            if (abbreviationPlaceholder) {
                abbreviationPlaceholder.style.fontSize = `${size * 0.15}px`;
            }
        }

        function togglePreview() {
            previewEnabled = !previewEnabled;
            togglePreviewBtn.classList.toggle('disabled', !previewEnabled);
            localStorage.setItem('previewEnabled', previewEnabled);
            if (!previewEnabled) {
                hidePreview();
            }
        }

        function toggleInProgressMode() {
            inProgressMode = !inProgressMode;
            inProgressButton.classList.toggle('active', inProgressMode);

            const currentSearchValue = searchInput.value.toLowerCase().trim();

            document.querySelectorAll('.cell').forEach(cell => {
                const game = games.find(g => g.id === parseInt(cell.dataset.gameId));
                cell.classList.remove('completed', 'in-progress');
                if (game.completed) {
                    cell.classList.add('completed');
                } else if (game.inProgress) {
                    cell.classList.add('in-progress');
                }
            });

            updateInProgressRow();
            updateSaturation();

            if (currentSearchValue) {
                document.querySelectorAll('.cell').forEach(cell => {
                    const gameName = cell.title.toLowerCase();
                    if (gameName.includes(currentSearchValue)) {
                        cell.style.display = '';
                    } else {
                        cell.style.display = 'none';
                    }
                });
            }
        }

        function toggleHideCompleted() {
            if (completedFilter.classList.contains('active')) {
                return;
            }
            hideCompleted = !hideCompleted;
            hideCompletedButton.classList.toggle('active');
            localStorage.setItem('hideCompleted', hideCompleted);

            // Делаем кнопку "Только пройденные" неактивной, если нажата кнопка "Скрыть пройденные"
            completedFilter.classList.toggle('button-disabled', hideCompleted);

            // Добавляем или удаляем класс hidden для пройденных игр
            document.querySelectorAll('.cell.completed').forEach(cell => {
                cell.classList.toggle('hidden', hideCompleted);
            });

            applyFilters();
            updateSaturation();
        }

        function resetProgress() {
            if (confirm('Вы уверены, что хотите сбросить весь прогресс?')) {
                const currentSaturation = saturationSlider.value;
                games.forEach(game => {
                    game.completed = false;
                    game.inProgress = false;
                });
                completedGames = 0;
                localStorage.removeItem('completedGames');
                localStorage.removeItem('inProgressGames');

                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('completed', 'in-progress');
                });

                updateInProgressRow();

                grid.innerHTML = '';
                games.forEach(game => {
                    if (!game.inProgress) {
                        const cell = createCell(game);
                        grid.appendChild(cell);
                    }
                });

                inProgressRow.innerHTML = '';
                updateInProgressRow();
                applyFilters();
                updateCounter();
                updateProgressBar();

                searchInput.value = '';
                searchGames();

                saturationSlider.value = currentSaturation;
                updateSaturation();
                saveGames();
            }
        }

        function searchGames() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            document.querySelectorAll('.cell').forEach(cell => {
                const gameName = cell.title.toLowerCase();
                const gameId = cell.getAttribute('data-game-id');
                const game = games.find(g => g.id.toString() === gameId);

                if (game && shouldShowGame(game) && (searchTerm === '' || gameName.includes(searchTerm))) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            });
            updateInProgressRow();
        }

        let currentSearchTerm = '';

        function handleSearch() {
            currentSearchTerm = searchInput.value.trim();
            applyFilters();
        }

        function clearSearch() {
            searchInput.value = '';
            currentSearchTerm = '';
            applyFilters();
            updateCounter();
        }

        function populateFilters() {
            // Фильтруем игры без года (null) при определении диапазона лет
            const years = [...new Set(games.filter(game => game.year !== null).map(game => game.year))].sort((a, b) => a - b);
            const platforms = [...new Set(games.flatMap(game => game.platforms))].sort();
            const genres = [...new Set(games.flatMap(game => game.genres))].sort();

            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);
            // Проверяем, активен ли фильтр по годам
            if (savedMinYear && parseInt(savedMinYear) > minGameYear) {
                minYear = parseInt(savedMinYear);
            } else {
                minYear = minGameYear;
                // Удаляем значение из localStorage, если оно равно минимальному году
                if (savedMinYear) {
                    localStorage.removeItem('minYear');
                }
            }

            if (savedMaxYear && parseInt(savedMaxYear) < maxGameYear) {
                maxYear = parseInt(savedMaxYear);
            } else {
                maxYear = maxGameYear;
                // Удаляем значение из localStorage, если оно равно максимальному году
                if (savedMaxYear) {
                    localStorage.removeItem('maxYear');
                }
            }

            // Обновляем атрибуты ползунков
            yearSliderMin.min = minGameYear;
            yearSliderMin.max = maxGameYear;
            yearSliderMin.value = minYear;
            yearSliderMax.min = minGameYear;
            yearSliderMax.max = maxGameYear;
            yearSliderMax.value = maxYear;

            // Обновляем метки годов
            document.getElementById('minYearLabel').textContent = minGameYear;
            document.getElementById('maxYearLabel').textContent = maxGameYear;

            updateYearValue();

            platformsList.innerHTML = '';
            genresList.innerHTML = '';

            const uniquePlatforms = [...new Set(platforms)];
            const uniqueGenres = [...new Set(genres)];

            uniquePlatforms.forEach(platform => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `platform-${platform}`;
                checkbox.value = platform;
                checkbox.checked = selectedPlatforms.includes(platform);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedPlatforms.push(platform);
                    } else {
                        selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
                    }
                    localStorage.setItem('selectedPlatforms', JSON.stringify(selectedPlatforms));
                    applyFilters();
                });
                // Создаем контейнер для чекбокса и метки
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'flex-start';
                container.style.marginBottom = '3px';

                // Добавляем чекбокс в контейнер
                container.appendChild(checkbox);

                // Создаем метку
                const label = document.createElement('label');
                label.htmlFor = `platform-${platform}`;
                label.textContent = platform;
                label.style.marginLeft = '6px';
                label.style.wordWrap = 'break-word';
                label.style.whiteSpace = 'normal';
                label.style.flex = '1';

                // Добавляем метку в контейнер
                container.appendChild(label);

                // Добавляем контейнер в список
                platformsList.appendChild(container);
            });

            uniqueGenres.forEach(genre => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `genre-${genre}`;
                checkbox.value = genre;
                checkbox.checked = selectedGenres.includes(genre);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedGenres.push(genre);
                    } else {
                        selectedGenres = selectedGenres.filter(g => g !== genre);
                    }
                    localStorage.setItem('selectedGenres', JSON.stringify(selectedGenres));
                    applyFilters();
                });
                // Создаем контейнер для чекбокса и метки
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'flex-start';
                container.style.marginBottom = '3px';

                // Добавляем чекбокс в контейнер
                container.appendChild(checkbox);

                // Создаем метку
                const label = document.createElement('label');
                label.htmlFor = `genre-${genre}`;
                label.textContent = genre;
                label.style.marginLeft = '6px';
                label.style.wordWrap = 'break-word';
                label.style.whiteSpace = 'normal';
                label.style.flex = '1';

                // Добавляем метку в контейнер
                container.appendChild(label);

                // Добавляем контейнер в список
                genresList.appendChild(container);
            });
        }

        function updateYearValue() {
            const minYear = parseInt(yearSliderMin.value);
            const maxYear = parseInt(yearSliderMax.value);
            yearValue.textContent = minYear === maxYear ? `${minYear}` : `${minYear} - ${maxYear}`;

            // Проверяем, установлены ли ползунки на минимальное и максимальное значения
            const years = [...new Set(games.filter(game => game.year !== null).map(game => game.year))].sort((a, b) => a - b);
            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);

            // Если ползунки установлены на минимальное и максимальное значения, удаляем значения из localStorage
            if (minYear <= minGameYear) {
                localStorage.removeItem('minYear');
            } else {
                localStorage.setItem('minYear', minYear);
            }

            if (maxYear >= maxGameYear) {
                localStorage.removeItem('maxYear');
            } else {
                localStorage.setItem('maxYear', maxYear);
            }

            // Обновляем подсветку трека ползунка
            updateSliderTrack();

            // Обновляем позицию тултипов
            updateTooltips();
        }

        // Функция для обновления подсветки трека ползунка
        function updateSliderTrack() {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            const minPos = (minVal - yearSliderMin.min) / (yearSliderMin.max - yearSliderMin.min) * 100;
            const maxPos = (maxVal - yearSliderMax.min) / (yearSliderMax.max - yearSliderMax.min) * 100;

            const trackHighlight = document.querySelector('.slider-track-highlight');
            trackHighlight.style.left = `${minPos}%`;
            trackHighlight.style.width = `${maxPos - minPos}%`;
        }

        // Функция для обновления позиции тултипов
        function updateTooltips() {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            const minPos = (minVal - yearSliderMin.min) / (yearSliderMin.max - yearSliderMin.min) * 100;
            const maxPos = (maxVal - yearSliderMax.min) / (yearSliderMax.max - yearSliderMax.min) * 100;

            const minTooltip = document.querySelector('.min-tooltip');
            const maxTooltip = document.querySelector('.max-tooltip');

            minTooltip.textContent = minVal;
            maxTooltip.textContent = maxVal;

            minTooltip.style.left = `${minPos}%`;
            maxTooltip.style.left = `${maxPos}%`;
        }

        function shouldShowGame(game) {
            const minGameYear = Math.min(...games.filter(g => g.year !== null).map(g => g.year));
            const showCompleted = completedFilter.classList.contains('active');
            return (
                (!hideCompleted || !game.completed) &&
                (showCompleted ? game.completed : true) &&
                (selectedGenres.length === 0 || game.genres.some(genre => selectedGenres.includes(genre))) &&
                (selectedPlatforms.length === 0 || game.platforms.some(platform => selectedPlatforms.includes(platform))) &&
                (game.year === null || (game.year >= Math.max(yearSliderMin.value, minGameYear) && game.year <= yearSliderMax.value))
            );
        }

        function applyFilters(forceIdSort = false) {
            const searchTerm = currentSearchTerm.toLowerCase();
            let visibleGames = 0;
            let hiddenGames = [];
            let firstInProgressMatchElement = null; // Store the first matching element in inProgressRow

            // Проверяем, изменились ли фильтры по годам
            const years = [...new Set(games.filter(g => g.year !== null).map(g => g.year))].sort((a, b) => a - b);
            const minGameYear = Math.min(...years);
            const maxGameYear = Math.max(...years);

            // Проверяем, изменены ли ползунки из их стандартного положения
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);

            // Фильтр считается активным, если пользователь изменил ползунки
            const isYearFilterActive = minVal > minGameYear || maxVal < maxGameYear;

            // Если фильтр по годам активен и не указан параметр forceIdSort, пересортируем игры в сетке
            if (isYearFilterActive && !forceIdSort) {
                // Собираем все игры, которые не в режиме "in progress"
                const gridCells = Array.from(grid.children);
                const gridGames = [];

                // Сохраняем связь между игрой и ячейкой
                gridCells.forEach(cell => {
                    const gameId = cell.getAttribute('data-game-id');
                    const game = games.find(g => g.id.toString() === gameId);
                    if (game) {
                        gridGames.push({ game, cell });
                    }
                });

                // Сортируем игры по году (игры без года в конец)
                gridGames.sort((a, b) => {
                    // Если обе игры имеют год, сортируем по возрастанию
                    if (a.game.year !== null && b.game.year !== null) {
                        return a.game.year - b.game.year;
                    }
                    // Если только у первой игры нет года, она идет в конец
                    if (a.game.year === null && b.game.year !== null) {
                        return 1;
                    }
                    // Если только у второй игры нет года, она идет в конец
                    if (a.game.year !== null && b.game.year === null) {
                        return -1;
                    }
                    // Если у обеих игр нет года, сортируем по ID
                    return a.game.id - b.game.id;
                });

                // Очищаем сетку
                grid.innerHTML = '';

                // Добавляем ячейки в новом порядке
                gridGames.forEach(item => {
                    grid.appendChild(item.cell);
                });
            }

            // Reset styles/visibility first
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('search-match-in-progress');
                // Decide initial visibility based on filters ONLY (not search yet)
                const gameId = cell.getAttribute('data-game-id');
                const game = games.find(g => g.id.toString() === gameId);
                if (game && shouldShowGame(game)) {
                     cell.style.display = ''; // Show if passes filters
                } else {
                     cell.style.display = 'none'; // Hide if fails filters
                     if(game) hiddenGames.push(game); // Keep track of hidden games
                }
            });

            // Now handle search term specifically
            if (searchTerm !== '') {
                document.querySelectorAll('#inProgressRow .cell').forEach(cell => {
                    const gameId = cell.getAttribute('data-game-id');
                    const game = games.find(g => g.id.toString() === gameId);
                    const matchesSearch = game.name.toLowerCase().includes(searchTerm);

                    if (cell.style.display !== 'none') { // Only consider cells currently visible based on filters
                        if (matchesSearch) {
                            if (!firstInProgressMatchElement) {
                                firstInProgressMatchElement = cell; // Found the first one
                            }
                        } else {
                            cell.style.display = 'none'; // Hide if doesn't match search
                        }
                    }
                });

                // Handle non-inProgress cells for search
                 document.querySelectorAll('#grid .cell').forEach(cell => {
                     if (cell.style.display !== 'none') { // Only consider cells currently visible based on filters
                        const gameId = cell.getAttribute('data-game-id');
                        const game = games.find(g => g.id.toString() === gameId);
                        const matchesSearch = game.name.toLowerCase().includes(searchTerm);
                        if (!matchesSearch) {
                            cell.style.display = 'none'; // Hide if doesn't match search
                        }
                     }
                 });

                // Move the first match to the beginning and apply style
                if (firstInProgressMatchElement) {
                    inProgressRow.insertBefore(firstInProgressMatchElement, inProgressRow.firstChild);
                    firstInProgressMatchElement.classList.add('search-match-in-progress');
                }

            } else {
                 // If search is cleared, ensure all filter-passing cells are visible
                 document.querySelectorAll('.cell').forEach(cell => {
                    const gameId = cell.getAttribute('data-game-id');
                    const game = games.find(g => g.id.toString() === gameId);
                     if (game && shouldShowGame(game)) {
                         cell.style.display = '';
                     }
                 });
            }

            // Count visible games AFTER applying search filter
            visibleGames = Array.from(document.querySelectorAll('.cell')).filter(cell => cell.style.display !== 'none').length;

            // DO NOT call updateInProgressRow() here.
            updateSaturation(); // This seems fine to call.
        }

        function toggleCompletedFilter() {
            if (hideCompleted) {
                return;
            }
            completedFilter.classList.toggle('active');
            const isActive = completedFilter.classList.contains('active');
            localStorage.setItem('completedFilterActive', isActive); // Сохраняем состояние
            applyFilters();
            hideCompletedButton.classList.toggle('button-disabled', isActive);
            // saveGames(); // saveGames здесь, вероятно, не нужен, так как состояние игры не меняется
            updateFiltersAndCounter();
        }

        let currentRandomGame = null;

        function selectRandomGame() {
            const availableGames = games.filter(game => !game.completed && !game.inProgress);
            if (availableGames.length === 0) {
                alert('Нет доступных игр для выбора');
                return;
            }
            const randomGame = availableGames[Math.floor(Math.random() * availableGames.length)];
            currentRandomGame = randomGame;
            showRandomSelection(randomGame);
        }

        document.getElementById('wantToPlayButton').onclick = function() {
            if (currentRandomGame) {
                currentRandomGame.inProgress = true;
                saveGames();
                updateInProgressRow();
                hideRandomSelection();
            }
        };

        function showRandomSelection(game) {
            const randomCell = document.querySelector(`.cell[data-game-id="${game.id}"]`);

            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.display = 'none';
            });

            let imgSrc = game.image_url || game.imageUrl;
            let content;
            if (!imgSrc) {
                const displayText = game.name;
                content = `
                    <div class="abbreviation-placeholder" style="width: 200px; height: 300px; display: flex; justify-content: center; align-items: center; font-size: 48px; background-color: #333;">
                        <span style="color: ${game.color};">${displayText}</span>
                    </div>
                `;
            } else {
                content = `<img src="${imgSrc}" alt="${game.name}">`;
            }

            const yearText = game.year ? ` (${game.year})` : ' (N/A)';
            randomSelected.innerHTML = `
                ${content}
                <p>${game.name}${yearText}</p>
            `;
            randomSelectedContainer.style.display = 'flex';

            const isLastOfUs2 = game.name.toLowerCase().includes('the last of us part ii');

            document.getElementById('dontWantButton').textContent = isLastOfUs2 ? 'Да ну нафиг' : 'Не хочу';
            document.getElementById('wantToPlayButton').textContent = isLastOfUs2 ? 'Ну, с богом' : 'Хочу пройти!';
            document.getElementById('anotherRandomButton').textContent = isLastOfUs2 ? 'Давай может другую, а?' : 'Давай другую';

            document.getElementById('topButtons').style.display = 'flex';
            document.getElementById('anotherRandomButton').style.display = 'block';

            document.getElementById('wantToPlayButton').onclick = () => {
                game.inProgress = true;
                if (randomCell) {
                    randomCell.classList.add('in-progress');
                    if (randomCell.parentElement === grid) {
                        grid.removeChild(randomCell);
                    }
                    // Добавляем ячейку в строку "В процессе" *перед* обновлением
                    inProgressRow.appendChild(randomCell);
                }
                updateInProgressRow(); // Обновляем строку "В процессе"
                applyFilters(); // Применяем фильтры к обновленному состоянию
                hideRandomSelection(); // Скрываем окно выбора (которое тоже вызывает applyFilters, но это не страшно)
                saveGames();
                // randomSelectedContainer.style.display = 'none'; // Это делается внутри hideRandomSelection
                currentRandomGame = null;
            };

            document.getElementById('dontWantButton').onclick = () => {
                currentRandomGame = null;
                hideRandomSelection();
            };

            document.getElementById('anotherRandomButton').onclick = () => {
                currentRandomGame = null;
                selectRandomGame();
            };

            setTimeout(() => {
                const selectedImg = randomSelected.querySelector('img');
                const abbreviationPlaceholder = randomSelected.querySelector('.abbreviation-placeholder');
                const containerWidth = (randomSelectedContainer.clientWidth - 40) * 1.5;
                const containerHeight = (randomSelectedContainer.clientHeight - 200) * 1.5;

                if (abbreviationPlaceholder) {
                    abbreviationPlaceholder.style.width = '200px';
                    abbreviationPlaceholder.style.height = '300px';
                } else if (selectedImg) {
                    const imgAspectRatio = selectedImg.naturalWidth / selectedImg.naturalHeight;
                    if (selectedImg.naturalWidth > containerWidth || selectedImg.naturalHeight > containerHeight) {
                        if (containerWidth / imgAspectRatio <= containerHeight) {
                            selectedImg.style.width = '150%';
                            selectedImg.style.height = 'auto';
                        } else {
                            selectedImg.style.width = 'auto';
                            selectedImg.style.height = `${containerHeight}px`;
                        }
                    } else {
                        selectedImg.style.width = `${selectedImg.naturalWidth * 1.5}px`;
                        selectedImg.style.height = `${selectedImg.naturalHeight * 1.5}px`;
                    }
                }
            }, 0);
        }

        function hideRandomSelection() {
            randomSelectedContainer.style.display = 'none';
            // Убран цикл, который сбрасывал display для всех ячеек
            document.getElementById('topButtons').style.display = 'none';
            document.getElementById('anotherRandomButton').style.display = 'none';
            applyFilters(); // Эта функция теперь корректно установит видимость
        }

        function resetFilters() {
            yearSliderMin.value = yearSliderMin.min;
            yearSliderMax.value = yearSliderMax.max;
            updateYearValue();

            platformsList.querySelectorAll('input').forEach(input => {
                input.checked = false;
            });
            selectedPlatforms = [];

            genresList.querySelectorAll('input').forEach(input => {
                input.checked = false;
            });
            selectedGenres = [];

            completedFilter.classList.remove('active');
            hideCompletedButton.classList.remove('active');
            hideCompleted = false;

            completedFilter.classList.remove('button-disabled');
            hideCompletedButton.classList.remove('button-disabled');

            localStorage.removeItem('selectedPlatforms');
            localStorage.removeItem('selectedGenres');
            localStorage.removeItem('minYear');
            localStorage.removeItem('maxYear');
            localStorage.removeItem('hideCompleted');

            const currentSaturation = saturationSlider.value;

            // Убираем сброс поиска и вызов searchGames()
            // searchInput.value = '';
            // searchGames();

            // Убираем цикл, который делает все ячейки видимыми.
            // document.querySelectorAll('.cell').forEach(cell => {
            //     cell.style.display = '';
            //     cell.classList.remove('hidden');
            // });

            // Перерисовываем все игры с нуля, сортируя по ID
            grid.innerHTML = '';
            inProgressRow.innerHTML = '';

            // Сортируем игры по ID
            const sortedGames = [...games].sort((a, b) => a.id - b.id);

            sortedGames.forEach(game => {
                const cell = createCell(game);
                if (game.inProgress) {
                    inProgressRow.appendChild(cell);
                } else {
                    grid.appendChild(cell);
                }
            });

            updateInProgressRow();

            applyFilters(); // Эта функция теперь применит сброшенные фильтры и ТЕКУЩИЙ поисковый запрос

            saturationSlider.value = currentSaturation;
            updateSaturation();
            updateCounter();
            // Убираем updateInProgressRow(), так как applyFilters уже должен обработать порядок
            // updateInProgressRow();
        }

        function showAuthorCredit() {
            authorCredit.style.display = 'block';
            clearTimeout(authorCreditTimeout);
            authorCreditTimeout = setTimeout(() => {
                authorCredit.style.display = 'none';
            }, 3000);
        }

        completedFilter.addEventListener('click', toggleCompletedFilter);
        randomButton.addEventListener('click', selectRandomGame);
        saturationSlider.addEventListener('input', updateSaturation);

        // Обработчики событий для ползунка минимального года
        yearSliderMin.addEventListener('input', () => {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            if (minVal > maxVal - 1) {
                yearSliderMin.value = maxVal - 1;
            }
            updateYearValue();
            applyFilters();
        });

        yearSliderMin.addEventListener('mouseover', () => {
            document.querySelector('.min-tooltip').style.opacity = '1';
        });

        yearSliderMin.addEventListener('mouseout', () => {
            document.querySelector('.min-tooltip').style.opacity = '0';
        });

        // Обработчики событий для ползунка максимального года
        yearSliderMax.addEventListener('input', () => {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            if (maxVal < minVal + 1) {
                yearSliderMax.value = minVal + 1;
            }
            updateYearValue();
            applyFilters();
        });

        yearSliderMax.addEventListener('mouseover', () => {
            document.querySelector('.max-tooltip').style.opacity = '1';
        });

        yearSliderMax.addEventListener('mouseout', () => {
            document.querySelector('.max-tooltip').style.opacity = '0';
        });

        // Инициализация подсветки трека и тултипов при загрузке
        updateSliderTrack();
        updateTooltips();

        // Добавим обработчики событий для анимации полосок после загрузки игр
        setTimeout(() => {
            try {
                // Находим заголовки по тексту
                const headers = Array.from(document.querySelectorAll('#filtersPanel h4'));
                const platformsHeader = headers.find(h => h.textContent === 'Платформы:');
                const genresHeader = headers.find(h => h.textContent === 'Жанры:');

                if (platformsHeader && genresHeader) {
                    // Обработчики для списка платформ
                    platformsList.addEventListener('mouseenter', () => {
                        platformsHeader.classList.add('active');
                    });

                    platformsList.addEventListener('mouseleave', () => {
                        platformsHeader.classList.remove('active');
                    });

                    platformsHeader.addEventListener('mouseenter', () => {
                        platformsHeader.classList.add('active');
                    });

                    platformsHeader.addEventListener('mouseleave', () => {
                        if (!platformsList.matches(':hover')) {
                            platformsHeader.classList.remove('active');
                        }
                    });

                    // Обработчики для списка жанров
                    genresList.addEventListener('mouseenter', () => {
                        genresHeader.classList.add('active');
                    });

                    genresList.addEventListener('mouseleave', () => {
                        genresHeader.classList.remove('active');
                    });

                    genresHeader.addEventListener('mouseenter', () => {
                        genresHeader.classList.add('active');
                    });

                    genresHeader.addEventListener('mouseleave', () => {
                        if (!genresList.matches(':hover')) {
                            genresHeader.classList.remove('active');
                        }
                    });
                }
            } catch (error) {
                console.error('Error setting up header animations:', error);
            }
        }, 1000); // Даем время на загрузку игр и фильтров

        // Добавляем переменную для отслеживания состояния ползунка
        let sizeSliderMoving = false;

        // Изменяем обработчик события для ползунка отдаления/приближения
        sizeSlider.addEventListener('mousedown', () => {
            sizeSliderMoving = true;
            // Сохранение состояния видимости игр в блоке "в процессе" теперь в функции applyFilters()
        });

        // Добавляем обработчик события touchstart для мобильных устройств
        sizeSlider.addEventListener('touchstart', () => {
            sizeSliderMoving = true;
        });

        sizeSlider.addEventListener('mouseup', () => {
            sizeSliderMoving = false;
            applyFilters();
        });

        // Добавляем обработчик события touchend для мобильных устройств
        sizeSlider.addEventListener('touchend', () => {
            sizeSliderMoving = false;

            // Обновляем строку "в процессе" и применяем фильтры после отпускания ползунка
            updateInProgressRow();
            applyFilters();
        });

        sizeSlider.addEventListener('input', () => {
            sizeSliderMoving = true;
            updateGridSize();
        });

        // Добавляем обработчик события при отпускании ползунка
        sizeSlider.addEventListener('change', () => {
            sizeSliderMoving = false;

            // Обновляем строку "в процессе" и применяем фильтры после отпускания ползунка
            updateInProgressRow();
            applyFilters();
        });

        // Добавляем обработчики для случая, если мышь уходит за пределы окна
        document.addEventListener('mouseup', () => {
            if (sizeSliderMoving) {
                sizeSliderMoving = false;

                // Обновляем строку "в процессе" и применяем фильтры после отпускания ползунка
                updateInProgressRow();
                applyFilters();
            }
        });
        togglePreviewBtn.addEventListener('click', togglePreview);
        inProgressButton.addEventListener('click', toggleInProgressMode);
        hideCompletedButton.addEventListener('click', toggleHideCompleted);
        resetButton.addEventListener('click', () => {
            resetProgress();
            hideRandomSelection();
        });

        searchInput.addEventListener('input', handleSearch);
        searchInput.addEventListener('blur', () => {
            if (searchInput.value.trim() === '') {
                currentSearchTerm = '';
                applyFilters();
            }
        });
        clearSearchButton.addEventListener('click', clearSearch);
        filtersButton.addEventListener('click', (event) => {
            event.stopPropagation();

            // Проверяем, открыта или закрыта панель фильтров
            if (filtersPanel.style.display === 'none' || filtersPanel.style.display === '') {
                // Открываем панель
                filtersPanel.style.display = 'block';

                // Устанавливаем высоту списков в зависимости от размера экрана
                if (typeof setListsHeight === 'function') {
                    // Даем небольшую задержку, чтобы панель успела отобразиться
                    setTimeout(setListsHeight, 10);
                }
            } else {
                // Закрываем панель
                filtersPanel.style.display = 'none';
            }
        });
        resetFiltersButton.addEventListener('click', resetFilters);

        const savedSize = localStorage.getItem('gridSize');
        if (savedSize) {
            sizeSlider.value = savedSize;
            updateGridSize();
        }

        togglePreviewBtn.classList.toggle('disabled', !previewEnabled);

        populateFilters();
        games.forEach(game => {
            const cell = createCell(game);
            if (game.inProgress) {
                inProgressRow.appendChild(cell);
            } else {
                grid.appendChild(cell);
            }
        });
        updateInProgressRow();

        updateCounter();

        hideCompletedButton.classList.toggle('active', hideCompleted);
        document.querySelectorAll('.cell.completed').forEach(cell => {
            cell.classList.toggle('hidden', hideCompleted);
        });

        populateFilters();
        applyFilters();
        updateInProgressRow();

        window.addEventListener('resize', () => { // Обновляем обработчик resize
            updateInProgressRow();
            applyFilters(true); // Применяем фильтры после обновления ряда, принудительно сортируя по ID

            // Устанавливаем высоту списков в зависимости от размера экрана
            if (typeof setListsHeight === 'function') {
                setListsHeight();
            }
        });
        updateInProgressRow();

        const resetFiltersButtonHeader = document.getElementById('resetFiltersButtonHeader');
        resetFiltersButtonHeader.addEventListener('click', function(event) {
            event.stopPropagation();
            resetFilters();
        });

        document.addEventListener('click', (event) => {
            if (!randomSelectedContainer.contains(event.target) && event.target !== randomButton) {
                hideRandomSelection();
            }
        });

        // Закрытие панели фильтров при клике вне ее (и вне модального окна списка игр)
        document.addEventListener('click', (event) => {
            const isClickInsideFilters = filtersPanel.contains(event.target);
            const isClickInsideCustomListModal = customGameListModal.contains(event.target);
            const isFiltersButton = event.target === filtersButton || filtersButton.contains(event.target);
            const isCustomListButton = event.target === customGameListButton; // Не закрывать при клике на кнопку открытия списка

            if (!isClickInsideFilters && !isFiltersButton && !isClickInsideCustomListModal && !isCustomListButton) {
                 filtersPanel.style.display = 'none';
            }
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                updateGridSize(); // Может вызвать updateInProgressRow
                updateInProgressRow(); // Убедимся, что ряд обновлен
                applyFilters(true); // Применяем фильтры повторно после возможных перерисовок, принудительно сортируя по ID
            }, 100);
        });

        window.dispatchEvent(new Event('resize'));

        const addGameButton = document.getElementById('addGameButton');
        const customGameListButton = document.getElementById('customGameListButton');
        const addGameModal = document.getElementById('addGameModal');
        const customGameListModal = document.getElementById('customGameListModal');
        const addGameForm = document.getElementById('addGameForm');
        const customGameList = document.getElementById('customGameList');

        let customGames = JSON.parse(localStorage.getItem('customGames')) || [];

        function deleteAllApiGames() {
            if (confirm('Вы уверены, что хотите удалить все добавленные игры?')) {
                const initialCount = games.length;
                games = games.filter(game => !game.isCustom && !game.importedFromApi);
                const deletedCount = initialCount - games.length;

                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    const gameId = cell.getAttribute('data-game-id');
                    const game = games.find(g => g.id.toString() === gameId);
                    if (!game) {
                        cell.remove();
                    }
                });

                saveGames();

                completedGames = games.filter(game => game.completed).length;
                updateCounter();
                populateFilters();
                applyFilters();

                console.log(`Удалено ${deletedCount} добавленных игр`);

                updateCustomGameList();
            }
        }

        const deleteAllApiGamesButton = document.getElementById('deleteAllApiGamesButton');
        if (deleteAllApiGamesButton) {
            deleteAllApiGamesButton.addEventListener('click', deleteAllApiGames);
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            if (modal === addGameModal) {
                resetAddGameForm();
            }
        }

        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                if (closeBtn.closest('.modal') === addGameModal) {
                    closeAddGameModal();
                } else {
                    closeModal(closeBtn.closest('.modal'));
                }
            });
        });

        // Добавляем переменную для отслеживания активного поля ввода
        let isInputActive = false;

        // Отслеживаем фокус на полях ввода
        document.addEventListener('focusin', (event) => {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                isInputActive = true;
            }
        });

        // Отслеживаем потерю фокуса на полях ввода
        document.addEventListener('focusout', (event) => {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                // Даем небольшую задержку, чтобы проверить, не перешел ли фокус на другое поле ввода
                setTimeout(() => {
                    const activeElement = document.activeElement;
                    if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
                        isInputActive = false;
                    }
                }, 100);
            }
        });

        window.addEventListener('click', (event) => {
            // Если клик по модальному окну и нет активного поля ввода
            if (event.target.classList.contains('modal') && !isInputActive) {
                if (event.target === addGameModal) {
                    closeAddGameModal();
                } else {
                    closeModal(event.target);
                }
            }
        });

        addGameButton.addEventListener('click', () => {
            addGameModal.style.display = 'block';
        });

        customGameListButton.addEventListener('click', () => {
            updateCustomGameList();
            customGameListModal.style.display = 'block';
        });

        let isEditing = false;
        let editingGameId = null;

        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('gameName').value.trim();

            if (!name) {
                alert('Название игры обязательно для заполнения');
                return;
            }

            if (!isEditing && isNameOrAbbreviationExists(name, '')) {
                alert('Игра с таким или похожим названием, или её ремейк/ремастер уже существует');
                return;
            }

            const gameData = {
                id: isEditing ? editingGameId : Date.now(),
                name: name,
                year: parseInt(document.getElementById('gameYear').value) || null,
                platforms: document.getElementById('gamePlatforms').value.split(',').map(p => p.trim()).filter(p => p),
                genres: document.getElementById('gameGenres').value.split(',').map(g => g.trim()).filter(g => g),
                imageUrl: document.getElementById('gameImageUrl').value.trim() || null,
                isCustom: true,
                importedFromApi: false,
                completed: false,
                inProgress: false,
                color: getRandomPastelColor()
            };

            if (isEditing) {
                updateGame(editingGameId, gameData);
            } else {
                addNewGame(gameData);
            }

            closeModal(addGameModal);
            resetAddGameForm();
        }

        function addNewGame(gameData) {
            const existingGame = findExistingGame(gameData);
            if (existingGame) {
                console.log('Найдена существующая версия игры:', existingGame.name);
                if (gameData.name.length < existingGame.name.length) {
                    Object.assign(existingGame, gameData);
                    updateGameCell(existingGame);
                } else {
                }
            } else {
                const newGame = {
                    id: Date.now(),
                    ...gameData,
                    isCustom: true,
                    importedFromApi: gameData.importedFromApi || false,
                    completed: false,
                    inProgress: false,
                    color: getRandomPastelColor()
                };
                games.push(newGame);
                const cell = createCell(newGame);

                // Добавляем ячейку в сетку с учетом сортировки по году
                insertCellInOrder(cell);
            }

            saveGames();
            updateCounter();
            populateFilters();
            applyFilters();
            updateGridSize();
        }

        document.getElementById('addGameForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('gameName').value.trim();

            if (!name) {
                alert('Название игры обязательно для заполнения');
                return;
            }

            const gameData = {
                name: name,
                year: parseInt(document.getElementById('gameYear').value) || null,
                platforms: document.getElementById('gamePlatforms').value.split(',').map(p => p.trim()).filter(p => p),
                genres: document.getElementById('gameGenres').value.split(',').map(g => g.trim()).filter(g => g),
                imageUrl: document.getElementById('gameImageUrl').value.trim() || null,
            };

            addNewGame(gameData);

            closeModal(addGameModal);
            this.reset();
        });

        function updateGame(gameId, gameData) {
            const game = customGames.find(g => g.id.toString() === gameId);
            if (game) {
                Object.assign(game, gameData);
                localStorage.setItem('customGames', JSON.stringify(customGames));
                updateCustomGameList();
                updateGameCell(game);
            }
        }

        function editCustomGame(gameId) {
            const game = customGames.find(g => g.id.toString() === gameId);
            if (game) {
                document.getElementById('gameName').value = game.name;
                document.getElementById('gameYear').value = game.year || '';
                document.getElementById('gamePlatforms').value = game.platforms.join(', ');
                document.getElementById('gameGenres').value = game.genres.join(', ');
                document.getElementById('gameImageUrl').value = game.imageUrl || '';

                document.querySelector('#addGameModal h2').textContent = 'Редактировать игру';

                document.querySelector('#addGameForm button[type="submit"]').textContent = 'Сохранить';

                addGameModal.style.display = 'block';
                customGameListModal.style.display = 'none';

                isEditing = true;
                editingGameId = gameId;
            }
        }

        function resetAddGameForm() {
            document.getElementById('gameName').value = '';
            document.getElementById('gameYear').value = '';
            document.getElementById('gamePlatforms').value = '';
            document.getElementById('gameGenres').value = '';
            document.getElementById('gameImageUrl').value = '';

            document.querySelector('#addGameModal h2').textContent = 'Добавить новую игру';
            document.querySelector('#addGameForm button[type="submit"]').textContent = 'Добавить';

            isEditing = false;
            editingGameId = null;
        }

        addGameForm.addEventListener('submit', handleFormSubmit);

        function createCell(game) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.gameId = game.id.toString();
            if (game.completed) {
                cell.classList.add('completed');
            }
            if (game.inProgress) {
                cell.classList.add('in-progress');
            }
            if (game.isCustom) {
                cell.classList.add('custom-game');
            }

            let img;
            if (game.imageUrl) {
                img = document.createElement('img');
                img.src = game.imageUrl;
                img.alt = game.name;
                const currentSaturation = saturationSlider.value;
                img.style.filter = `saturate(${currentSaturation}%)`;
                cell.appendChild(img);
            } else {
                const color = game.color || getRandomPastelColor();
                if (!game.color) {
                    game.color = color;
                }
                const placeholder = document.createElement('div');
                placeholder.className = 'abbreviation-placeholder';
                placeholder.innerHTML = `<span style="color: ${color};">${game.name}</span>`;
                cell.appendChild(placeholder);
            }

            cell.title = game.name;
            cell.addEventListener('click', () => toggleCell(cell, game.id));

            // Handle hover animation with JS
            let scaleTimeoutId = null;
            cell.addEventListener('mouseenter', (e) => {
                clearTimeout(scaleTimeoutId); // Clear any pending scale-back timeout
                cell.classList.add('scaling-out');
                showPreviewOrTitle(e, game); // Keep showing preview/title logic
            });

            cell.addEventListener('mouseleave', () => {
                 scaleTimeoutId = setTimeout(() => {
                    cell.classList.remove('scaling-out');
                 }, 50); // Wait for transition to finish (200ms)
                 hidePreviewAndTitle(); // Keep hiding preview/title logic
            });

             // Keep mousemove for title/preview positioning if needed, but not for scaling
             cell.addEventListener('mousemove', (e) => {
                 if (gameTitle.style.display === 'block' || preview.style.display === 'block') {
                    showPreviewOrTitle(e, game); // Update position if visible
                 }
             });

            updateCellSize(cell, game.inProgress);

            return cell;
        }


        function removeGameCell(gameId) {
            const cell = document.querySelector(`.cell[data-game-id="${gameId}"]`);
            if (cell) {
                cell.remove();
            }
        }

        function getRandomPastelColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 10;
            const lightness = 60 + Math.random() * 10;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function updateCustomGameList() {
            customGameList.innerHTML = '';
            const searchTerm = document.getElementById('customGameSearchInput').value.toLowerCase();

            games.forEach(game => {
                if (game.name.toLowerCase().includes(searchTerm)) {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'custom-game-item';
                    gameElement.innerHTML = `
                        <span>${game.name}</span>
                        <div>
                            <button class="delete-game" data-id="${game.id}">Удалить</button>
                        </div>
                    `;
                    customGameList.appendChild(gameElement);
                }
            });

            customGameList.removeEventListener('click', customGameListClickHandler);
            customGameList.addEventListener('click', customGameListClickHandler);
        }

        document.getElementById('customGameSearchInput').addEventListener('input', updateCustomGameList);

        function customGameListClickHandler(e) {
            if (e.target.classList.contains('delete-game')) {
                const gameId = e.target.dataset.id;
                if (gameId) {
                    deleteGame(gameId);
                } else {
                    console.error('ID игры не найден');
                }
            }
        }

        function deleteGame(gameId) {
            if (gameId && confirm('Вы уверены, что хотите удалить эту игру?')) {
                games = games.filter(g => g.id.toString() !== gameId.toString());
                localStorage.setItem('games', JSON.stringify(games));

                const cellToRemove = document.querySelector(`.cell[data-game-id="${gameId}"]`);
                if (cellToRemove) {
                    cellToRemove.remove();
                } else {
                }

                updateCustomGameList();
                updateCounter();
                populateFilters();
                applyFilters();
                updateGridSize();
            }
        }

        function updateGameCell(game) {
            const cell = document.querySelector(`.cell[data-game-id="${game.id}"]`);
            if (cell) {
                cell.title = game.name;
                if (game.imageUrl) {
                    cell.innerHTML = `<img src="${game.imageUrl}" alt="${game.name}">`;
                } else {
                    cell.innerHTML = `<div class="abbreviation-placeholder"><span style="color: ${game.color};">${getAbbreviation(game.name)}</span></div>`;
                }
                updateCellSize(cell, game.inProgress);
            }
        }

        function loadCustomGames() {
            customGames.forEach(game => {
                if (!games.some(g => g.id === game.id)) {
                    games.push(game);
                    const cell = createCell(game);
                    grid.appendChild(cell);
                }
            });
            updateGridSize();
            populateFilters();
            applyFilters();
        }

        loadCustomGames();

        function updateSaturation() {
            const saturation = saturationSlider.value;
            document.documentElement.style.setProperty('--saturation', `${saturation}%`);
            document.querySelectorAll('.cell:not(.in-progress) img').forEach(img => {
                img.classList.add('saturated');
                img.style.filter = `saturate(var(--saturation))`;
            });
            localStorage.setItem('saturation', saturation);
        }

        function normalizeGameName(name) {
            return name.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/^(the|a|an)\s+/, '')
                .trim();
        }
        function getGameNumber(name) {
            const match = name.match(/\d+$/);
            return match ? parseInt(match[0]) : null;
        }

        function removeVersionSuffixes(name) {
            const suffixes = [
                'hd', 'remake', 'remaster', 'remastered', 'definitive edition',
                'special edition', 'complete edition', 'directors cut',
                'game of the year', 'goty', 'enhanced edition', 'anniversary edition',
                'collectors edition', 'extended edition', 'gold edition', 'platinum edition'
            ];
            const regex = new RegExp(`\\s+(${suffixes.join('|')})(?:\\s+edition)?$`, 'i');
            return name.replace(regex, '');
        }

        function isNameOrAbbreviationExists(name, abbreviation, excludeId = null) {
            const normalizedName = normalizeGameName(name);
            return games.some(game => {
                if (game.id === excludeId) return false;

                const gameNormalizedName = normalizeGameName(game.name);
                const gameAbbreviation = game.abbreviation ? normalizeGameName(game.abbreviation) : '';
                const newAbbreviation = abbreviation ? normalizeGameName(abbreviation) : '';

                return gameNormalizedName === normalizedName ||
                    (gameAbbreviation && gameAbbreviation === newAbbreviation) ||
                    levenshteinDistance(gameNormalizedName, normalizedName) <= 2;
            });
        }

        function getBaseGameName(name) {
            return name.toLowerCase()
                .replace(/[^a-zа-я0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/^(the|a|an)\s+/, '')
                .replace(/\s+(hd|remake|remaster|remastered|definitive edition|special edition|complete edition|directors cut|game of the year|goty|enhanced edition|anniversary edition|collectors edition|extended edition|gold edition|platinum edition|premium edition|ultimate edition)(\s+edition)?$/i, '')
                .trim();
        }

        function generateGameId(name) {
            return getBaseGameName(name).replace(/\s+/g, '-');
        }

        function findExistingGame(newGame) {
            const normalizedNewName = normalizeGameName(newGame.name);
            return games.find(game => {
                const normalizedExistingName = normalizeGameName(game.name);
                return normalizedExistingName === normalizedNewName ||
                       levenshteinDistance(normalizedExistingName, normalizedNewName) <= 2;
            });
        }

        function isRemakeOrRemaster(existingName, newName) {
            const normalizedExisting = normalizeGameName(existingName);
            const normalizedNew = normalizeGameName(newName);
            return normalizedExisting === normalizedNew || levenshteinDistance(normalizedExisting, normalizedNew) <= 2;
        }

        function isSpecialVersion(name) {
            const specialVersions = [
                'hd', 'remake', 'remaster', 'remastered', 'definitive edition',
                'special edition', 'complete edition', 'directors cut',
                'game of the year', 'goty', 'enhanced edition', 'anniversary edition',
                'collectors edition', 'extended edition', 'gold edition', 'platinum edition'
            ];
            const regex = new RegExp(`\\b(${specialVersions.join('|')})\\b`, 'i');
            return regex.test(name);
        }

        function isDuplicateGame(newGame) {
            const normalizedNewName = normalizeGameName(newGame.name);
            const newGameNumber = getGameNumber(newGame.name);
            if (isSpecialVersion(newGame.name)) {
                return true;
            }

            const existingGame = games.find(game => {
                const normalizedExistingName = normalizeGameName(game.name);
                const existingGameNumber = getGameNumber(game.name);

                const namesMatch = normalizedExistingName === normalizedNewName;
                const numberMatch = newGameNumber === existingGameNumber;

                const similarNames = levenshteinDistance(normalizedExistingName, normalizedNewName) <= 1;

                if (namesMatch || similarNames) {
                }

                return (namesMatch || similarNames) && (newGameNumber === null || numberMatch);
            });

            if (existingGame) {
                return true;
            }

            return false;
        }

        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            const matrix = [];

            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[b.length][a.length];
        }

        const selectPlatformsBtn = document.getElementById('selectPlatformsBtn');
        const selectGenresBtn = document.getElementById('selectGenresBtn');
        const selectOptionsModal = document.getElementById('selectOptionsModal');
        const selectOptionsTitle = document.getElementById('selectOptionsTitle');
        const optionsList = document.getElementById('optionsList');
        const applyOptionsBtn = document.getElementById('applyOptionsBtn');

        let currentSelectType = '';

        function showSelectOptions(type) {
            currentSelectType = type;
            selectOptionsTitle.textContent = type === 'platforms' ? 'Выберите платформы' : 'Выберите жанры';

            const options = type === 'platforms'
                ? [...new Set(games.flatMap(game => game.platforms))]
                : [...new Set(games.flatMap(game => game.genres))];

            const inputField = type === 'platforms' ? document.getElementById('gamePlatforms') : document.getElementById('gameGenres');
            const selectedValues = inputField.value.split(',').map(v => v.trim());

            optionsList.innerHTML = options.map(option => `
                <label>
                    <input type="checkbox" value="${option}" ${selectedValues.includes(option) ? 'checked' : ''}> ${option}
                </label>
            `).join('');

            selectOptionsModal.style.display = 'block';
        }

        customGameListButton.addEventListener('click', () => {
            updateCustomGameList();
            customGameListModal.style.display = 'block';
        });

        document.addEventListener('click', function(event) {
            if (event.target.id === 'selectPlatformsBtn') {
                showSelectOptions('platforms');
            } else if (event.target.id === 'selectGenresBtn') {
                showSelectOptions('genres');
            }
        });

        applyOptionsBtn.addEventListener('click', () => {
            const selectedOptions = Array.from(optionsList.querySelectorAll('input:checked')).map(input => input.value);
            const inputField = currentSelectType === 'platforms' ? document.getElementById('gamePlatforms') : document.getElementById('gameGenres');
            inputField.value = selectedOptions.join(', ');
            selectOptionsModal.style.display = 'none';
        });

        selectOptionsModal.querySelector('.close').addEventListener('click', () => {
            selectOptionsModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === selectOptionsModal) {
                selectOptionsModal.style.display = 'none';
            }
        });

        document.addEventListener('click', (event) => {
            if (event.target.id === 'importFromApiButton' || event.target.id === 'importFromApiModalButton') {
                importFromIGDB();
            }
        });

        let isImporting = false;

        async function importFromIGDB(count = 100) {
            if (isImporting) {
                return;
            }

            isImporting = true;
            showLoadingMessage();
            console.log('Начало импорта игр из IGDB');
            try {
                const existingIds = games.map(game => game.id.toString());
                const indexResponse = await fetch('data/index.json');
                if (!indexResponse.ok) {
                    throw new Error(`Ошибка загрузки индекса: ${indexResponse.status} ${indexResponse.statusText}`);
                }
                const index = await indexResponse.json();

                let newGames = [];
                for (let i = 1; i <= index.total_files; i++) {
                    const response = await fetch(`data/games_${i}.json`);
                    if (!response.ok) {
                        throw new Error(`Ошибка загрузки файла games_${i}.json: ${response.status} ${response.statusText}`);
                    }
                    const fileGames = await response.json();
                    newGames = newGames.concat(fileGames.filter(game => !existingIds.includes(game.id.toString())));
                    if (newGames.length >= count) {
                        break;
                    }
                }

                let addedGames = 0;
                const maxGamesToAdd = Math.min(count, 3000 - games.length);

                for (const game of newGames) {
                    if (addedGames >= maxGamesToAdd) {
                        break;
                    }
                    const newGame = {
                        id: game.id,
                        name: game.name,
                        imageUrl: game.cover ? convertImageUrl(game.cover.url) : '',
                        year: game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : null,
                        genres: game.genres ? game.genres.map(g => g.name) : [],
                        platforms: game.platforms ? game.platforms.map(p => getPlatformName(p.id)).filter(p => p !== null) : [],
                        rating: game.aggregated_rating || game.rating,
                        isCustom: true,
                        importedFromApi: true,
                        completed: false,
                        inProgress: false
                    };
                    if (!isDuplicateGame(newGame)) {
                        await addNewGameWithDelay(newGame);
                        addedGames++;
                    } else {
                        console.log(`Игра "${newGame.name}" не добавлена`);
                    }
                }

                console.log('Импорт завершен успешно');
                alert(`Импорт завершен. Добавлено ${addedGames} новых игр.`);
            } catch (error) {
                console.error('Ошибка при импорте игр из IGDB:', error);
                alert(`Не удалось импортировать игры: ${error.message}`);
            } finally {
                hideLoadingMessage();
                isImporting = false;
            }
        }

        function addNewGameWithDelay(game) {
            return new Promise(resolve => {
                setTimeout(() => {
                    addNewGame(game);
                    saveGames();
                    updateFiltersAndCounter();
                    resolve();
                    updateSaturation();
                }, 10);
            });
        }

        function addNewGame(game) {
            games.push(game);
            const cell = createCell(game);
            grid.appendChild(cell);
            updateGridSize();
            saveGames();
            updateFiltersAndCounter();
            updateSaturation();
        }

        function convertImageUrl(url) {
            const baseUrl = 'https://images.igdb.com/igdb/image/upload/t_cover_big/';
            const fileName = url.split('/').pop();
            return baseUrl + fileName;
        }

        function updateFiltersAndCounter() {
            populateFilters();
            updateCounter();
        }

        function chunkArray(array, size) {
            const chunked = [];
            for (let i = 0; i < array.length; i += size) {
                chunked.push(array.slice(i, i + size));
            }
            return chunked;
        }

        function showLoadingMessage() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingMessage() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function initializeImportButton() {
            const importButton = document.getElementById('importFromApiButton');
            const importModalButton = document.getElementById('importFromApiModalButton');
            const searchGameModalButton = document.getElementById('searchGameModalButton');
            const closeSearchResultsButton = document.getElementById('closeSearchResults');

            if (importButton) {
                importButton.addEventListener('click', () => importFromIGDB(100));
            } else {
            }

            if (importModalButton) {
                importModalButton.addEventListener('click', () => importFromIGDB(100));
            } else {
                console.error('Кнопка импорта в модальном окне не найдена');
            }

            if (searchGameModalButton) {
                searchGameModalButton.addEventListener('click', () => importFromIGDB(10));
            } else {
                console.error('Кнопка поиска игры в модальном окне не найдена');
            }

            // Удалено, так как функционал перенесен на кнопку-крестик
        }

        function clearSearchResults() {
            const searchResults = document.getElementById('searchResults');
            const searchGameInput = document.getElementById('searchGameInput');
            if (searchResults) {
                searchResults.innerHTML = '';
            }
            if (searchGameInput) {
                searchGameInput.value = '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM полностью загружен');
            initializeImportButton();
            loadSavedGames();
            renderGames(true); // Принудительно сортируем по ID при загрузке страницы
            updateCounter();
            populateFilters();
            updateInProgressRow(); // Сначала размещаем ячейки по рядам
            initializeCacheClearing();

            // Восстанавливаем состояние completedFilter и hideCompletedButton перед применением фильтров
            const savedCompletedFilterActive = localStorage.getItem('completedFilterActive') === 'true';
            if (savedCompletedFilterActive) {
                completedFilter.classList.add('active');
                hideCompletedButton.classList.add('button-disabled');
            } else {
                 completedFilter.classList.remove('active');
                 hideCompletedButton.classList.remove('button-disabled');
            }
            // Восстанавливаем состояние hideCompletedButton (уже сделано выше)
            // hideCompletedButton.classList.toggle('active', hideCompleted);


            applyFilters(true); // Применяем фильтры после всей инициализации и расстановки ячеек, принудительно сортируя по ID

            const addGameButton = document.getElementById('addGameButton');
            const addGameModal = document.getElementById('addGameModal');

            completedFilter.addEventListener('click', toggleCompletedFilter);
            hideCompletedButton.addEventListener('click', toggleHideCompleted);

            const performSearchButton = document.getElementById('performSearchButton');
            if (performSearchButton) {
                performSearchButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    searchGameFromApi();
                });
            }

            const searchGameInput = document.getElementById('searchGameInput');
            const clearSearchInputButton = document.getElementById('clearSearchInputButton');

            if (searchGameInput) {
                // Обработчик нажатия Enter
                searchGameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchGameFromApi();
                    }
                });

                // Обработчик ввода текста для отображения/скрытия кнопки очистки
                searchGameInput.addEventListener('input', () => {
                    if (searchGameInput.value.trim() !== '') {
                        clearSearchInputButton.style.display = 'flex';
                    } else {
                        clearSearchInputButton.style.display = 'none';
                    }
                });
            }

            // Обработчик для кнопки очистки поля ввода
            if (clearSearchInputButton) {
                clearSearchInputButton.addEventListener('click', () => {
                    searchGameInput.value = '';
                    clearSearchInputButton.style.display = 'none';
                    searchGameInput.focus();
                    clearSearchResults(); // Добавляем функционал кнопки "Очистить"
                });
            }

            if (addGameButton) {
                addGameButton.addEventListener('click', () => {
                    addGameModal.style.display = 'block';
                });
            } else {
                console.error('Кнопка "Добавить игру" в шапке не найдена');
            }

            const searchGameButton = document.getElementById('searchGameButton');

            const searchInputContainer = document.getElementById('searchInputContainer');
            if (searchInputContainer) {
                searchInputContainer.style.display = 'block';
            }

            // Динамическая настройка высоты списков платформ и жанров
            function calculateListHeight() {
                // Рассчитываем высоту в зависимости от размера экрана
                const viewportHeight = window.innerHeight;

                // Базовая высота списков
                let listHeight = 150; // Средняя высота по умолчанию

                // Если экран большой, увеличиваем высоту
                if (viewportHeight > 900) {
                    listHeight = 200; // Максимальная высота для больших экранов
                } else if (viewportHeight > 700) {
                    listHeight = 150; // Средняя высота для стандартных экранов
                } else {
                    listHeight = 100; // Минимальная высота для маленьких экранов
                }

                return listHeight;
            }

            // Функция для установки высоты списков
            function setListsHeight() {
                const platformsList = document.getElementById('platformsList');
                const genresList = document.getElementById('genresList');
                const filtersPanel = document.getElementById('filtersPanel');

                if (!platformsList || !genresList || filtersPanel.style.display !== 'block') {
                    return;
                }

                // Рассчитываем оптимальную высоту
                const listHeight = calculateListHeight();

                // Устанавливаем одинаковую высоту для обоих списков
                platformsList.style.maxHeight = `${listHeight}px`;
                genresList.style.maxHeight = `${listHeight}px`;
            }

            // Устанавливаем начальную высоту списков
            const platformsList = document.getElementById('platformsList');
            const genresList = document.getElementById('genresList');

            if (platformsList && genresList) {
                const initialHeight = calculateListHeight();
                platformsList.style.maxHeight = `${initialHeight}px`;
                genresList.style.maxHeight = `${initialHeight}px`;
            }


        });
    </script>
</body>
</html>
