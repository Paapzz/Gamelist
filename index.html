<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ТОП ИГР НА ПРОХОЖДЕНИЕ</title>
    <style>
        body {
            background-color: #222;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #333;
            padding: 5px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            overflow: hidden;
            height: 30px; 
        }
        #leftGroup, #rightGroup {
            display: flex;
            align-items: center;
        }
        #togglePreview, #resetButton, #inProgressButton, #hideCompletedButton, #filtersButton, #clearSearchButton, #resetFiltersButton, #randomButton, #completedFilter, #importFromApiButton, #addGameButton {
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #togglePreview {
            background-color: #4CAF50;
        }
        #togglePreview.disabled {
            background-color: #9E9E9E;
            cursor: not-allowed;
        }
        #resetButton {
            background-color: #f44336;
        }
        #inProgressButton {
            background-color: #ff9900;
            transition: all 0.3s ease;
        }
        #inProgressButton.active {
            background-color: #FFA726;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(255, 152, 0, 0.7);
            transform: translateY(2px);
        }
        #hideCompletedButton {
            background-color: #2196F3;
        }
        #hideCompletedButton.active {
            background-color: #1976D2;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(33, 150, 243, 0.7);
            transform: translateY(2px);
        }
        #filtersButton {
            background-color: #4CAF50;
        }
        #clearSearchButton {
            background-color: #f44336;
            width: 24px;
            height: 24px;
            padding: 0;
            margin-left: 5px;
            font-size: 18px;
            line-height: 24px;
        }
        #randomButton {
            background-color: #2a2a2a;
        }
        #addGameButton {
            background-color: #2196F3;
        }
        #togglePreview:hover, #resetButton:hover, #inProgressButton:hover, #hideCompletedButton:hover, #filtersButton:hover, #clearSearchButton:hover, #resetFiltersButton:hover, #randomButton:hover, #importFromApiButton:hover, #addGameButton:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #togglePreview:active, #resetButton:active, #inProgressButton:active, #hideCompletedButton:active, #filtersButton:active, #clearSearchButton:active, #resetFiltersButton:active, #randomButton:active, #importFromApiButton:active, #addGameButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #customGameListButton {
            background-color: #e4ac35;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #customGameListButton:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        #customGameListButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #progressBarContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        #progressBarPattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, 
                black, 
                violet, 
                blue, 
                green, 
                yellow, 
                orange, 
                red
            );
        }
        #progressBarCover {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #333;
            transform-origin: right;
            transition: transform 0.5s;
        }
        #searchGameButton {
            background-color: #2196F3;  /* Синий цвет, можете изменить по вашему усмотрению */
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #searchGameButton:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #searchGameButton:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #deleteAllCustomGamesButton, #deleteAllApiGamesButton {
            margin-right: 10px;
        }
        #counterContainer {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 15px; 
            padding: 3px 10px; 
            z-index: 1;
            height: 24px; 
            display: flex;
            align-items: center;
        }
        #counter {
            color: white;
            font-weight: bold;
            font-size: 18px; 
        }
        #grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 5px;
            padding: 60px 10px 50px;
        }
        .cell {
            position: relative;
            aspect-ratio: 0.75;
            cursor: pointer;
            transition: filter 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }
        .cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: filter 0.3s;
        }
        .cell.completed img {
            filter: brightness(85%);
        }
        .cell.completed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                linear-gradient(to top right, transparent calc(50% - 1px), red calc(50% - 1px), red calc(50% + 1px), transparent calc(50% + 1px)),
                linear-gradient(to bottom right, transparent calc(50% - 1px), red calc(50% - 1px), red calc(50% + 1px), transparent calc(50% + 1px));
            z-index: 2;
            pointer-events: none;
            filter: saturate(100%) !important;
        }
        .cell.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom right, transparent calc(50% - 1px), #fff, transparent calc(50% + 1px));
            pointer-events: none;
        }
        .cell.in-progress {
            position: relative; 
            background: none;
        }
        .cell.in-progress::before {
            content: none;
        }
        .cell.search-dimmed {
            filter: brightness(30%);
        }
        .cell.search-highlight {
            animation: highlight 5s ease-in-out infinite;
        }
        @keyframes highlight {
            0% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); }
            50% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8); }
            100% { box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5); }
        }
        .cell.hidden {
            display: none;
        }
        #sizeSlider {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30vw
        }
        .preview {
            position: fixed;
            display: none;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 5px;
            border-radius: 2px;
            z-index: 1001;
            pointer-events: none;
            transition: opacity 1s ease-out;
            transform: translate(0, -50%);
            top: 50%;
        }
        .preview-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .preview img {
            max-width: 65vw;
            max-height: 65vh;
            object-fit: contain;
        }
        .preview p {
            margin: 5px 0 0;
            text-align: center;
            font-size: 14px;
        }
        .game-title {
            position: fixed;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            pointer-events: none;
            display: none;
            text-align: center;
        }
        .game-title .game-year {
            display: block;
            font-size: 0.8em;
            margin-top: 2px;
        }
        #searchInput {
            margin-left: 10px;
            padding: 3px;
            font-size: 14px;
        }
        #filtersPanel {
            position: fixed;
            top: 40px;
            left: 10px;
            background-color: #333;
            padding: 10px;
            border-radius: 5px;
            z-index: 1005;
            display: none;
        }
        #yearSlider {
            width: 100%;
        }
        #platformsList {
            max-height: 200px;
            overflow-y: auto;
        }
        #genresList {
            max-height: 200px;
            overflow-y: auto;
            margin: 12px;
        }
        .double-slider {
            position: relative;
            width: 100%;
            height: 40px;
        }
        .double-slider input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: none;
            pointer-events: none;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            appearance: none;
        }
        .double-slider input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            pointer-events: auto;
            margin-top: -6px;
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px rgba(76, 175, 80, 0.1);
            z-index: 3;
        }
        .double-slider input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 0 0 3px #fff, 0 0 0 6px rgba(76, 175, 80, 0.1);
            border: none;
            z-index: 3;
        }
        .slider-track {
            width: 100%;
            height: 4px;
            background: #ddd;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 2px;
            z-index: 1;
        }
        #yearValue {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            color: inherit;
        }
        #inProgressRow {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 5px;
            background-color: #333;
            border-bottom: 1px solid #555;
            justify-content: flex-start;
            align-items: flex-start;
        }
        #inProgressRow .cell {
            flex: 0 0 auto;
            width: calc(var(--cell-size) * 1.2);
            height: calc(var(--cell-size) * 1.2 * 1.33);
            border: none;
        }
        #mainContent {
            padding-top: 1px;
        }
        .cell.completed img {
            filter: brightness(85%);
        }
        #filterButtons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        #filterButtons button {
            flex: 1;
            margin: 0 5px;
        }
        #resetFiltersButtonContainer {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        #resetFiltersButton {
            width: 80%;
        }
        #resetFiltersButton {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #completedFilter {
            background-color: #4CAF50;
            color: white;
            border: none;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        #completedFilter, #hideCompletedButton {
            width: calc(50% - 10px);
        }
        #completedFilter {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }
        #resetFiltersButton {
            padding: 7px;
            width: 70%;
            margin: 2px auto;
            display: block;
        }
        #resetFiltersButton:hover {
            background-color: #b92f2f;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #hideCompletedButton:hover {
            background-color: #1976D2;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #completedFilter:hover {
            background-color: #16831b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);

        }
        #resetFiltersButton:active {
            background-color: #8a161c;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: translateY(6px);
        }
        #completedFilter:active {
            background-color: #17811d;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: translateY(2px);
        }
        #hideCompletedButton:active {
            background-color: #0D47A1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transform: translateY(2px);
        }
        #completedFilter.active, #hideCompletedButton.active {
            background-color: #1976D2;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(33, 150, 243, 0.7);
        }
        #completedFilter.active {
            background-color: #11831b;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(20, 190, 48, 0.671);
        }
        #saturationContainer {
            margin-top: 15px;
            text-align: center;
        }
        #saturationSlider {
            width: 100%;
            margin-top: 5px;
        }
        #randomButton {
            background-color: #2a2a2a;
            color: white;
            border: none;
            padding: 3px 8px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 0 5px;
            cursor: pointer;
            transition: background 0.3s;
            z-index: 1;
            height: 24px;
        }
        #randomButton:hover {
            background: linear-gradient(75deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400% 400%;
            animation: rainbow 222s linear infinite;
        }
        @keyframes rainbow { 
            to {
                background-position: 2000vh;
            }
        }
        .random-selected {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 65vw;
            height: 65vh;
        }
        .random-selected img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #authorCredit {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            font-size: 24px;
            display: none;
            z-index: 1010;
        }
        #randomSelectedContainer {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            max-width: 95vw;
            max-height: 95vh;
            overflow: auto;
        }
        #randomSelected {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #randomSelected img {
            max-width: 150%;
            max-height: calc(95vh - 200px);
            width: auto;
            height: auto;
            object-fit: contain;
            margin-bottom: 10px;
        }
        #randomSelected p {
            margin: 10px 0;
            font-size: 18px;
            word-wrap: break-word;
            max-width: 100%;
        }
        #topButtons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }
        #anotherRandomButton {
            display: block;
            margin: 20px auto 0;
        }
        #dontWantButton, #wantToPlayButton, #anotherRandomButton {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            transition: background-color 0.3s, transform 0.1s;
        }
        #dontWantButton, #wantToPlayButton {
            flex: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #dontWantButton {
            background-color: #f44336;
            color: white;
        }
        #wantToPlayButton {
            background-color: #4CAF50;
            color: white;
        }
        #anotherRandomButton {
            background-color: #FF9800;
            color: white;
            width: calc(100% - 20px);
        }
        #dontWantButton:hover, #wantToPlayButton:hover, #anotherRandomButton:hover {
            opacity: 0.9;
        }
        #dontWantButton:active, #wantToPlayButton:active, #anotherRandomButton:active {
            transform: scale(0.98);
        }
        .preview p {
            word-wrap: break-word;
            max-width: 100%;
        }
        #mainContent {
            padding-top: 40px;
        }
        #grid {
            padding-top: 5px;
        }
        .square-button {
            width: 24px;
            height: 24px;
            padding: 0;
            margin-left: 5px;
            font-size: 18px;
            line-height: 24px;
            text-align: center;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #clearSearchButton, #resetFiltersButtonHeader {
            background-color: #f44336;
            color: white;
        }
        #clearSearchButton:hover, #resetFiltersButtonHeader:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #clearSearchButton:active, #resetFiltersButtonHeader:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .cell.completed::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom right, transparent calc(50% - 1px), #fff, transparent calc(50% + 1px));
            pointer-events: none;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #2a2a2a;
            margin: 10% auto;
            padding: 30px;
            border: none;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close:hover,
        .close:focus {
            color: #fff;
        }
        #addGameForm {
            display: flex;
            flex-direction: column;
        }
        #addGameForm input {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3a3a3a;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        #addGameForm input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        #addGameForm label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        #addGameForm button,
        #cancelAddGame {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.1s;
        }
        #addGameForm button {
            background-color: #4CAF50;
            color: white;
        }
        #cancelAddGame {
            background-color: #f44336;
            color: white;
        }
        #addGameForm button:hover,
        #cancelAddGame:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        #addGameForm button:active,
        #cancelAddGame:active {
            transform: translateY(0);
        }
        .abbreviation-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            word-break: break-word;
            padding: 5%;
            box-sizing: border-box;
        }
        .custom-game .abbreviation-placeholder {
            background-color: #1a1a1a;
        }
        .preview .abbreviation-placeholder {
            width: 200px;
            height: 300px;
            font-size: 24px;
            background-color: #333;
        }
        .custom-game-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #444;
            border-radius: 5px;
        }
        .custom-game-item button {
            margin-left: 10px;
            padding: 5px 10px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .custom-game-item .delete-game {
            background-color: #f44336;
            color: white;
        }
        .custom-game-item .delete-game:hover {
            background-color: #d32f2f;
        }
        .delete-game {
            background-color: #f44336;
            color: white;
        }
        .required-fields {
            font-size: 12px;
            color: #888;
            margin-top: 10px;
        }
        .input-with-button {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .input-with-button .input-button-wrapper {
            display: flex;
            align-items: center;
        }
        .input-with-button input {
            flex-grow: 1;
            margin-right: 10px;
            margin-bottom: 0;
        }
        .input-with-button button {
            padding: 8px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transform: translateY(-5px);
        }
        .input-with-button button:hover {
            background-color: #1976D2;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .input-with-button button:active {
            background-color: #0D47A1;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        #optionsList {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        #optionsList label {
            display: block;
            margin-bottom: 5px;
        }
        #applyOptionsBtn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        #customGameSearchInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #customGameList {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        #customGameList::-webkit-scrollbar {
            width: 10px;
        }
        #customGameList::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #customGameList::-webkit-scrollbar-thumb {
            background: #888;
        }
        #customGameList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .abbreviation-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            font-size: 1.5em;
            font-weight: bold;
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            word-break: break-word;
            padding: 5%;
            box-sizing: border-box;
        }
        .preview .abbreviation-placeholder,
        #randomSelected .abbreviation-placeholder {
            width: 200px;
            height: 300px;
            font-size: 24px;
            background-color: #333;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="progressBarContainer">
            <div id="progressBarPattern"></div>
            <div id="progressBarCover"></div>
            <button id="importFromApiButton">Загрузить ТОП игр</button>
            <button id="searchGameButton">Найти игру</button>
        </div>
        <div id="leftGroup">
            <button id="togglePreview">Превью</button>
            <input type="text" id="searchInput" placeholder="Поиск игры...">
            <button id="clearSearchButton">×</button>
            <button id="filtersButton">Фильтры</button>
            <button id="resetFiltersButtonHeader" class="square-button">×</button>
        </div>
        <div id="counterContainer">
            <div id="counter">ройдено: 0 из 0</div>
        </div>
        <div id="rightGroup">
            <button id="randomButton">Random</button>
            <button id="inProgressButton">В процессе</button>
            <button id="addGameButton">Добавить игру</button>
            <button id="resetButton">Сброс</button>
        </div>
    </div>
    <div id="mainContent">
        <div id="inProgressRow"></div>
        <div id="grid"></div>
    </div>
    <input type="range" id="sizeSlider" min="25" max="250" value="50" step="1">
    <div class="preview" id="preview">
        <div class="preview-content">
            <img src="" alt="">
            <p></p>
        </div>
    </div>
    <div class="game-title" id="gameTitle"></div>
    <div id="filtersPanel">
        <h3>
            <button id="customGameListButton">Список игр</button>
        </h3>
        <label for="yearSlider">Год выпуска: <span id="yearValue"></span></label>
        <div class="double-slider">
            <input type="range" id="yearSliderMin" min="1950" max="2023" value="1950">
            <input type="range" id="yearSliderMax" min="1950" max="2023" value="2023">
            <div class="slider-track"></div>
        </div>
        <h4>Платформы:</h4>
        <div id="platformsList"></div>
        <h4>Жанры:</h4>
        <div id="genresList"></div>
        <div id="filterButtons">
            <button id="completedFilter">Только<br>пройденные</button>
            <button id="hideCompletedButton">Скрыть пройденные</button>
        </div>
        <div id="resetFiltersButtonContainer">
            <button id="resetFiltersButton">Сбросить фильтры</button>
        </div>
        <div id="saturationContainer">
            <label for="saturationSlider">Насыщенность</label>
            <input type="range" id="saturationSlider" min="0" max="100" value="100">
        </div>
    </div>
    <div id="authorCredit">Made by Papz</div>
    <div id="randomSelectedContainer">
        <div id="randomSelected"></div>
        <div id="topButtons">
            <button id="dontWantButton">Не хочу</button>
            <button id="wantToPlayButton">Хочу пройти!</button>
        </div>
        <button id="anotherRandomButton">давай другую</button>
    </div>

    <div id="addGameModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить новую игру</h2>
            <form id="addGameForm">
                <button type="button" id="importFromApiModalButton">Добавить ТОП игр до 2000</button>
                <label for="gameName">Название игры: *</label>
                <input type="text" id="gameName" required>
                
                <label for="gameYear">Год выпуска:</label>
                <input type="number" id="gameYear" min="1950" max="2099">
                
                <label for="gamePlatforms">Платформы:</label>
                <div class="input-with-button">
                    <input type="text" id="gamePlatforms">
                    <button type="button" id="selectPlatformsBtn">Выбрать</button>
                </div>
                
                <label for="gameGenres">Жанры:</label>
                <div class="input-with-button">
                    <input type="text" id="gameGenres">
                    <button type="button" id="selectGenresBtn">Выбрать</button>
                </div>
                
                <label for="gameImageUrl">URL изображения:</label>
                <input type="url" id="gameImageUrl">
                
                <div class="form-buttons">
                    <button type="submit">Добавить</button>
                </div>
                <p class="required-fields">* Обязательное поле</p>
            </form>
        </div>
    </div>
    <div id="selectOptionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="selectOptionsTitle"></h2>
            <div id="optionsList"></div>
            <button id="applyOptionsBtn">Применить</button>
        </div>
    </div>
    <div id="customGameListModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Список добавленных игр</h2>
            <input type="text" id="customGameSearchInput" placeholder="Поиск игры...">
            <div id="customGameList"></div>
            <button id="deleteAllApiGamesButton">Удалить все добавленные игры</button>
        </div>
    </div>

    <script>
        console.log('Скрипт начал выполнение');
        const mainContent = document.getElementById('mainContent');
        const grid = document.getElementById('grid');
        const counter = document.getElementById('counter');
        const sizeSlider = document.getElementById('sizeSlider');
        const preview = document.getElementById('preview');
        const togglePreviewBtn = document.getElementById('togglePreview');
        const resetButton = document.getElementById('resetButton');
        const hideCompletedButton = document.getElementById('hideCompletedButton');
        const inProgressButton = document.getElementById('inProgressButton');
        const gameTitle = document.getElementById('gameTitle');
        const progressBarCover = document.getElementById('progressBarCover');
        const searchInput = document.getElementById('searchInput');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const filtersButton = document.getElementById('filtersButton');
        const filtersPanel = document.getElementById('filtersPanel');
        const yearSliderMin = document.getElementById('yearSliderMin');
        const yearSliderMax = document.getElementById('yearSliderMax');
        const yearValue = document.getElementById('yearValue');
        const platformsList = document.getElementById('platformsList');
        const genresList = document.getElementById('genresList');
        const resetFiltersButton = document.getElementById('resetFiltersButton');
        const completedFilter = document.getElementById('completedFilter');
        const randomButton = document.getElementById('randomButton');
        const saturationSlider = document.getElementById('saturationSlider');
        const inProgressRow = document.getElementById('inProgressRow');
        const authorCredit = document.getElementById('authorCredit');
        let authorCreditTimeout;
        let completedGames = 0;
        let games = [];
        let previewTimeout;
        let previewEnabled = localStorage.getItem('previewEnabled') !== 'false';
        let inProgressMode = false;
        let hideCompleted = JSON.parse(localStorage.getItem('hideCompleted')) || false;

        let savedMinYear = localStorage.getItem('minYear');
        let savedMaxYear = localStorage.getItem('maxYear');
        let selectedPlatforms = JSON.parse(localStorage.getItem('selectedPlatforms')) || [];
        let selectedGenres = JSON.parse(localStorage.getItem('selectedGenres')) || [];
        const gamesList = [
        {"number":1,"title":"the-legend-of-zelda-breath-of-the-wild","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co3p2d.jpg","year":2017,"genres":["Action","Adventure","Open world","Puzzle","Role-playing (RPG)","Sandbox","Survival"],"platforms":["Nintendo Switch","Nintendo Wii U"]},
        {"number":2,"title":"the-last-of-us","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co1r7f.jpg","year":2013,"genres":["Action","Adventure","Horror","Shooter","Stealth","Survival"],"platforms":["PlayStation 3","PlayStation 4"]},
        {"number":3,"title":"tetris--4","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co6n9j.jpg","year":1985,"genres":["Arcade","Puzzle"],"platforms":["DOS","Electronika 60","Game Boy","Nintendo Entertainment System"]},
        {"number":4,"title":"half-life-2","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co1nmw.jpg","year":2004,"genres":["Action","Horror","Shooter"],"platforms":["Windows PC"]},
        {"number":5,"title":"the-legend-of-zelda-ocarina-of-time","image_url":"https://images.igdb.com/igdb/image/upload/t_cover_big/co3nnx.jpg","year":1998,"genres":["Action","Adventure","Open world","Role-playing (RPG)","Sandbox"],"platforms":["Nintendo 64"]},
        ];

        games = gamesList.map(game => ({
            id: game.number,
            name: game.title.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            imageUrl: game.image_url,
            year: game.year,
            genres: game.genres,
            platforms: game.platforms,
            completed: false,
            inProgress: false,
            isCustom: false
        }));

        function loadSavedGames() {
            const savedGames = localStorage.getItem('games');
            if (savedGames) {
                games = JSON.parse(savedGames);
                console.log('Загружено игр:', games.length);
                completedGames = games.filter(game => game.completed).length;
                updateInProgressRow();
            }
        }

        function saveGames() {
            localStorage.setItem('games', JSON.stringify(games));
            console.log('Игры сохранены в localStorage');
        }

        function updateCounter() {
            counter.textContent = `Пройдено: ${completedGames} из ${games.length}`;
            updateProgressBar();
        }

        function updateProgressBar() {
            const progress = completedGames / games.length;
            progressBarCover.style.transform = `scaleX(${1 - progress})`;
        }

        function toggleCell(cell, gameId) {
            console.log('Попытка переключения ячейки с ID:', gameId);
            if (!gameId) {
                console.error('ID игры не определен');
                return;
            }
            
            const game = games.find(g => g.id && g.id.toString() === gameId.toString());
            if (!game) {
                console.error('Игра не найдена для ID:', gameId);
                return;
            }
            
            console.log('Найдена игра:', game.name);
            
            if (inProgressMode) {
                if (!game.inProgress && !game.completed) {
                    game.inProgress = true;
                    game.completed = false;
                } else if (game.inProgress) {
                    game.inProgress = false;
                    game.completed = false;
                } else if (game.completed) {
                    game.inProgress = true;
                    game.completed = false;
                }
            } else {
                if (!game.completed && !game.inProgress) {
                    game.completed = true;
                    game.inProgress = false;
                    completedGames++;
                } else if (game.completed) {
                    game.completed = false;
                    game.inProgress = false;
                    completedGames--;
                } else if (game.inProgress) {
                    game.completed = true;
                    game.inProgress = false;
                    completedGames++;
                }
            }
            
            cell.classList.remove('completed', 'in-progress');
            if (game.completed) {
                cell.classList.add('completed');
            } else if (game.inProgress) {
                cell.classList.add('in-progress');
            }
            
            if (game.inProgress) {
                if (cell.parentElement !== inProgressRow) {
                    grid.removeChild(cell);
                    inProgressRow.appendChild(cell);
                }
            } else {
                if (cell.parentElement === inProgressRow) {
                    inProgressRow.removeChild(cell);
                    insertCellInOrder(cell);
                }
            }
            
            saveGames();
            
            if (hideCompleted) {
                cell.classList.toggle('hidden', game.completed);
            }
            
            hidePreviewAndTitle();
            updateCounter();
            updateInProgressRow();
            applyFilters();
            
            console.log('Ячейка успешно переключена');
        }

        function renderGames() {
            grid.innerHTML = '';
            inProgressRow.innerHTML = '';
            games.forEach(game => {
                const cell = createCell(game);
                if (game.inProgress) {
                    inProgressRow.appendChild(cell);
                } else {
                    grid.appendChild(cell);
                }
            });
            updateInProgressRow();
            applyFilters();
        }

        function insertCellInOrder(cell) {
            const gameId = parseInt(cell.dataset.gameId);
            const cells = Array.from(grid.children);
            const insertIndex = cells.findIndex(c => parseInt(c.dataset.gameId) > gameId);
            
            if (insertIndex === -1) {
                grid.appendChild(cell);
            } else {
                grid.insertBefore(cell, cells[insertIndex]);
            }
        }

        function renderGames() {
            grid.innerHTML = '';
            inProgressRow.innerHTML = '';
            games.forEach(game => {
                const cell = createCell(game);
                if (game.inProgress) {
                    inProgressRow.appendChild(cell);
                } else {
                    grid.appendChild(cell);
                }
            });
            updateInProgressRow();
            applyFilters();
        }

        function updateInProgressRow() {
            console.log('Обновление строки "В процессе"');
            inProgressRow.innerHTML = '';
            const inProgressGames = games.filter(game => game.inProgress);
            console.log('Игры в процессе:', inProgressGames.length);
            inProgressGames.forEach(game => {
                const cell = createCell(game);
                inProgressRow.appendChild(cell);
            });
            
            if (inProgressRow.children.length > 0) {
                inProgressRow.style.display = 'flex';
            } else {
                inProgressRow.style.display = 'none';
            }
            
            // Обновляем размеры ячеек
            const size = sizeSlider.value;
            inProgressRow.querySelectorAll('.cell').forEach(cell => {
                updateCellSize(cell, true);
            });
        }

        function getRandomPastelColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 10;
            const lightness = 60 + Math.random() * 10;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function showPreviewOrTitle(e, game) {
            if (game.completed) {
                showGameTitle(e, game);
            } else if (previewEnabled) {
                showPreview(e, game);
            } else {
                showGameTitle(e, game);
            }
        }

        function showPreview(e, game) {
            clearTimeout(previewTimeout);
            preview.style.opacity = '1';
            preview.style.display = 'block';
            const img = preview.querySelector('img');
            const abbreviationPlaceholder = preview.querySelector('.abbreviation-placeholder') || document.createElement('div');
            abbreviationPlaceholder.className = 'abbreviation-placeholder';
            
            if (game.imageUrl) {
                img.src = game.imageUrl;
                img.style.display = 'block';
                abbreviationPlaceholder.style.display = 'none';
            } else {
                img.style.display = 'none';
                abbreviationPlaceholder.innerHTML = `<span style="color: ${game.color};">${game.name}</span>`;
                abbreviationPlaceholder.style.display = 'flex';
                preview.querySelector('.preview-content').appendChild(abbreviationPlaceholder);
            }

            const updatePreviewPosition = () => {
                const previewRect = preview.getBoundingClientRect();
                const margin = window.innerWidth * 0.05;
                
                let currentSide = preview.style.right === 'auto' ? 'left' : 'right';
                
                if (currentSide === 'left' && e.clientX < previewRect.right + margin) {
                    currentSide = 'right';
                } else if (currentSide === 'right' && e.clientX > previewRect.left - margin) {
                    currentSide = 'left';
                }
                
                if (currentSide === 'left') {
                    preview.style.left = '5%';
                    preview.style.right = 'auto';
                } else {
                    preview.style.left = 'auto';
                    preview.style.right = '5%';
                }
            };

            if (game.imageUrl) {
                img.onload = () => {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const maxWidth = window.innerWidth * 0.65;
                    const maxHeight = window.innerHeight * 0.645;
                    let width = maxWidth;
                    let height = width / aspectRatio;
                    if (height > maxHeight) {
                        height = maxHeight;
                        width = height * aspectRatio;
                    }
                    img.style.width = `${width}px`;
                    img.style.height = `${height}px`;
                    
                    updatePreviewPosition();
                };
            } else {
                abbreviationPlaceholder.style.width = '200px';
                abbreviationPlaceholder.style.height = '300px';
                updatePreviewPosition();
            }

            const yearText = game.year ? ` (${game.year})` : '';
            preview.querySelector('p').textContent = `${game.name}${yearText}`;
            startPreviewTimeout();
        }

        function showGameTitle(e, game) {
            gameTitle.innerHTML = `${game.name}<span class="game-year">${game.year ? `(${game.year})` : ''}</span>`;
            gameTitle.style.display = 'block';
            
            const titleRect = gameTitle.getBoundingClientRect();
            const left = e.clientX - titleRect.width / 2;
            const top = e.clientY - titleRect.height - 10;

            gameTitle.style.left = `${Math.max(0, Math.min(left, window.innerWidth - titleRect.width))}px`;
            gameTitle.style.top = `${Math.max(0, top)}px`;
        }

        function updateGameInfoPosition(e, game) {
            if (previewEnabled) {
            } else {
                showGameTitle(e, game);
            }
        }

        function startPreviewTimeout() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(() => {
                preview.style.opacity = '0';
                setTimeout(() => {
                    if (preview.style.opacity === '0') {
                        preview.style.display = 'none';
                    }
                }, 1000);
            }, 3000);
        }

        function hidePreviewAndTitle() {
            hidePreview();
            hideGameTitle();
        }

        function hidePreview() {
            clearTimeout(previewTimeout);
            preview.style.opacity = '0';
            setTimeout(() => {
                if (preview.style.opacity === '0') {
                    preview.style.display = 'none';
                }
            }, 1000);
        }

        function hideGameTitle() {
            gameTitle.style.display = 'none';
        }

        function updateGridSize() {
            const size = sizeSlider.value;
            document.documentElement.style.setProperty('--cell-size', `${size}px`);
            grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${size}px, 1fr))`;
            localStorage.setItem('gridSize', size);
            
            updateAllCellSizes();
            updateInProgressRow();

            void grid.offsetHeight;
        }

        function updateAllCellSizes() {
            const size = sizeSlider.value;
            document.querySelectorAll('.cell').forEach(cell => {
                const isInProgress = cell.classList.contains('in-progress');
                updateCellSize(cell, isInProgress);
            });
        }

        function updateCellSize(cell, isInProgress) {
            const size = sizeSlider.value;
            if (isInProgress) {
                cell.style.width = `${size * 1.2}px`;
                cell.style.height = `${size * 1.2 * 1.33}px`;
            } else {
                cell.style.width = `${size}px`;
                cell.style.height = `${size * 1.33}px`;
            }
            
            const abbreviationPlaceholder = cell.querySelector('.abbreviation-placeholder');
            if (abbreviationPlaceholder) {
                abbreviationPlaceholder.style.fontSize = `${size * 0.15}px`;
            }
        }

        function togglePreview() {
            previewEnabled = !previewEnabled;
            togglePreviewBtn.classList.toggle('disabled', !previewEnabled);
            localStorage.setItem('previewEnabled', previewEnabled);
            if (!previewEnabled) {
                hidePreview();
            }
        }

        function toggleInProgressMode() {
            inProgressMode = !inProgressMode;
            inProgressButton.classList.toggle('active', inProgressMode);
            
            const currentSearchValue = searchInput.value.toLowerCase().trim();
            
            document.querySelectorAll('.cell').forEach(cell => {
                const game = games.find(g => g.id === parseInt(cell.dataset.gameId));
                cell.classList.remove('completed', 'in-progress');
                if (game.completed) {
                    cell.classList.add('completed');
                } else if (game.inProgress) {
                    cell.classList.add('in-progress');
                }
            });

            updateInProgressRow();
            
            if (currentSearchValue) {
                document.querySelectorAll('.cell').forEach(cell => {
                    const gameName = cell.title.toLowerCase();
                    if (gameName.includes(currentSearchValue)) {
                        cell.style.display = '';
                    } else {
                        cell.style.display = 'none';
                    }
                });
            }
        }

        function toggleHideCompleted() {
            hideCompleted = !hideCompleted;
            hideCompletedButton.classList.toggle('active', hideCompleted);
            document.querySelectorAll('.cell.completed').forEach(cell => {
                cell.classList.toggle('hidden', hideCompleted);
            });
            localStorage.setItem('hideCompleted', JSON.stringify(hideCompleted));
        }

        function resetProgress() {
            if (confirm('Вы уверены, что хотите сбросить весь прогрес?')) {
                games.forEach(game => {
                    game.completed = false;
                    game.inProgress = false;
                });
                completedGames = 0;
                localStorage.removeItem('completedGames');
                localStorage.removeItem('inProgressGames');
                
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('completed', 'in-progress');
                });

                updateInProgressRow();

                grid.innerHTML = '';
                games.forEach(game => {
                    if (!game.inProgress) {
                        const cell = createCell(game);
                        grid.appendChild(cell);
                    }
                });

                updateCounter();
                updateProgressBar();
                
                searchInput.value = '';
                searchGames();
            }
        }

        function searchGames(applyFilter = false) {
            const searchTerm = searchInput.value.toLowerCase().trim();
            document.querySelectorAll('.cell').forEach(cell => {
                const gameName = cell.title.toLowerCase();
                const gameId = cell.getAttribute('data-game-id');
                const game = games.find(g => g.id.toString() === gameId);
                
                if (game && shouldShowGame(game) && (searchTerm === '' || gameName.includes(searchTerm))) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            });
            updateInProgressRow();
        }


        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchGames(true);
            }
        }

        function clearSearch() {
            searchInput.value = '';
            searchGames();
            applyFilters();
        }

        function populateFilters() {
            const years = [...new Set(games.map(game => game.year))].sort((a, b) => a - b);
            const platforms = [...new Set(games.flatMap(game => game.platforms))].sort();
            const genres = [...new Set(games.flatMap(game => game.genres))].sort();

            minYear = savedMinYear ? Math.max(parseInt(savedMinYear), 1950) : Math.max(years[0], 1950);
            maxYear = savedMaxYear ? parseInt(savedMaxYear) : years[years.length - 1];

            yearSliderMin.min = 1950;
            yearSliderMin.max = years[years.length - 1];
            yearSliderMin.value = minYear;
            yearSliderMax.min = 1950;
            yearSliderMax.max = years[years.length - 1];
            yearSliderMax.value = maxYear;
            updateYearValue();

            platformsList.innerHTML = '';
            genresList.innerHTML = '';

            const uniquePlatforms = [...new Set(platforms)];
            const uniqueGenres = [...new Set(genres)];

            uniquePlatforms.forEach(platform => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `platform-${platform}`;
                checkbox.value = platform;
                checkbox.checked = selectedPlatforms.includes(platform);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedPlatforms.push(platform);
                    } else {
                        selectedPlatforms = selectedPlatforms.filter(p => p !== platform);
                    }
                    localStorage.setItem('selectedPlatforms', JSON.stringify(selectedPlatforms));
                    applyFilters();
                });
                const label = document.createElement('label');
                label.htmlFor = `platform-${platform}`;
                label.textContent = platform;
                platformsList.appendChild(checkbox);
                platformsList.appendChild(label);
                platformsList.appendChild(document.createElement('br'));
            });

            uniqueGenres.forEach(genre => {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `genre-${genre}`;
                checkbox.value = genre;
                checkbox.checked = selectedGenres.includes(genre);
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        selectedGenres.push(genre);
                    } else {
                        selectedGenres = selectedGenres.filter(g => g !== genre);
                    }
                    localStorage.setItem('selectedGenres', JSON.stringify(selectedGenres));
                    applyFilters();
                });
                const label = document.createElement('label');
                label.htmlFor = `genre-${genre}`;
                label.textContent = genre;
                genresList.appendChild(checkbox);
                genresList.appendChild(label);
                genresList.appendChild(document.createElement('br'));
            });
        }

        function updateYearValue() {
            const minYear = parseInt(yearSliderMin.value);
            const maxYear = parseInt(yearSliderMax.value);
            yearValue.textContent = minYear === maxYear ? `${minYear}` : `${minYear} - ${maxYear}`;
            localStorage.setItem('minYear', minYear);
            localStorage.setItem('maxYear', maxYear);
        }

        function shouldShowGame(game) {
            const minSelectedYear = Math.max(parseInt(yearSliderMin.value), 1950);
            const maxSelectedYear = parseInt(yearSliderMax.value);
            const yearMatch = game.year === null || game.year === undefined || (game.year >= minSelectedYear && game.year <= maxSelectedYear);
            const platformMatch = selectedPlatforms.length === 0 || game.platforms.some(platform => selectedPlatforms.includes(platform));
            const genreMatch = selectedGenres.length === 0 || game.genres.some(genre => selectedGenres.includes(genre));
            const completedMatch = !completedFilter.classList.contains('active') || game.completed;
            return yearMatch && platformMatch && genreMatch && completedMatch;
        }

        function applyFilters() {
            const showOnlyCompleted = completedFilter.classList.contains('active');
            const hideCompleted = hideCompletedButton.classList.contains('active');

            document.querySelectorAll('.cell').forEach(cell => {
                const gameId = cell.getAttribute('data-game-id');
                const game = games.find(g => g.id && g.id.toString() === gameId);
                
                if (game && shouldShowGame(game) && 
                    (!showOnlyCompleted || game.completed) && 
                    (!hideCompleted || !game.completed)) {
                    cell.style.display = '';
                } else {
                    cell.style.display = 'none';
                }
            });

            updateInProgressRow();
        }

        function toggleCompletedFilter() {
            completedFilter.classList.toggle('active');
            applyFilters();
        }

        let currentRandomGame = null;

        function selectRandomGame() {
            const availableGames = games.filter(game => !game.completed && !game.inProgress);
            if (availableGames.length === 0) {
                alert('Нет доступных игр для выбора');
                return;
            }
            const randomGame = availableGames[Math.floor(Math.random() * availableGames.length)];
            currentRandomGame = randomGame;
            showRandomSelection(randomGame);
        }

        document.getElementById('wantToPlayButton').onclick = function() {
            if (currentRandomGame) {
                currentRandomGame.inProgress = true;
                saveGames();
                updateInProgressRow();
                hideRandomSelection();
            }
        };

        function showRandomSelection(game) {
            const randomCell = document.querySelector(`.cell[data-game-id="${game.id}"]`);
            
            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.display = 'none';
            });
            
            let imgSrc = game.image_url || game.imageUrl;
            let content;
            if (!imgSrc) {
                const displayText = game.name;
                content = `
                    <div class="abbreviation-placeholder" style="width: 200px; height: 300px; display: flex; justify-content: center; align-items: center; font-size: 48px; background-color: #333;">
                        <span style="color: ${game.color};">${displayText}</span>
                    </div>
                `;
            } else {
                content = `<img src="${imgSrc}" alt="${game.name}">`;
            }
            
            const yearText = game.year ? ` (${game.year})` : '';
            randomSelected.innerHTML = `
                ${content}
                <p>${game.name}${yearText}</p>
            `;
            randomSelectedContainer.style.display = 'flex';
            
            const isLastOfUs2 = game.name.toLowerCase().includes('the last of us part ii');
            
            document.getElementById('dontWantButton').textContent = isLastOfUs2 ? 'Да ну нафиг' : 'Не хочу';
            document.getElementById('wantToPlayButton').textContent = isLastOfUs2 ? 'Ну, с богом' : 'Хочу пройти!';
            document.getElementById('anotherRandomButton').textContent = isLastOfUs2 ? 'Давай может другую, а?' : 'Давай другую';
            
            document.getElementById('topButtons').style.display = 'flex';
            document.getElementById('anotherRandomButton').style.display = 'block';
            
            document.getElementById('wantToPlayButton').onclick = () => {
                game.inProgress = true;
                if (randomCell) {
                    randomCell.classList.add('in-progress');
                    if (randomCell.parentElement === grid) {
                        grid.removeChild(randomCell);
                    }
                    inProgressRow.appendChild(randomCell);
                }
                hideRandomSelection();
                updateInProgressRow();
                saveGames();
                randomSelectedContainer.style.display = 'none';
                currentRandomGame = null;
            };
            
            document.getElementById('dontWantButton').onclick = () => {
                currentRandomGame = null;
                hideRandomSelection();
            };
            
            document.getElementById('anotherRandomButton').onclick = () => {
                currentRandomGame = null;
                selectRandomGame();
            };
            
            setTimeout(() => {
                const selectedImg = randomSelected.querySelector('img');
                const abbreviationPlaceholder = randomSelected.querySelector('.abbreviation-placeholder');
                const containerWidth = (randomSelectedContainer.clientWidth - 40) * 1.5;
                const containerHeight = (randomSelectedContainer.clientHeight - 200) * 1.5;
                
                if (abbreviationPlaceholder) {
                    abbreviationPlaceholder.style.width = '200px';
                    abbreviationPlaceholder.style.height = '300px';
                } else if (selectedImg) {
                    const imgAspectRatio = selectedImg.naturalWidth / selectedImg.naturalHeight;
                    if (selectedImg.naturalWidth > containerWidth || selectedImg.naturalHeight > containerHeight) {
                        if (containerWidth / imgAspectRatio <= containerHeight) {
                            selectedImg.style.width = '150%';
                            selectedImg.style.height = 'auto';
                        } else {
                            selectedImg.style.width = 'auto';
                            selectedImg.style.height = `${containerHeight}px`;
                        }
                    } else {
                        selectedImg.style.width = `${selectedImg.naturalWidth * 1.5}px`;
                        selectedImg.style.height = `${selectedImg.naturalHeight * 1.5}px`;
                    }
                }
            }, 0);
        }

        function hideRandomSelection() {
            randomSelectedContainer.style.display = 'none';
            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.display = '';
            });
            document.getElementById('topButtons').style.display = 'none';
            document.getElementById('anotherRandomButton').style.display = 'none';
            applyFilters();
        }

        function resetFilters() {
            console.log("Сброс фильтров начат");

            yearSliderMin.value = yearSliderMin.min;
            yearSliderMax.value = yearSliderMax.max;
            updateYearValue();

            platformsList.querySelectorAll('input').forEach(input => {
                input.checked = false;
            });
            selectedPlatforms = [];

            genresList.querySelectorAll('input').forEach(input => {
                input.checked = false;
            });
            selectedGenres = [];

            completedFilter.classList.remove('active');
            hideCompletedButton.classList.remove('active');
            hideCompleted = false;

            localStorage.removeItem('selectedPlatforms');
            localStorage.removeItem('selectedGenres');
            localStorage.removeItem('minYear');
            localStorage.removeItem('maxYear');
            localStorage.removeItem('hideCompleted');
            
            const currentSaturation = saturationSlider.value;
            
            searchInput.value = '';
            searchGames();
            
            // Показываем все игры
            document.querySelectorAll('.cell').forEach(cell => {
                cell.style.display = '';
                cell.classList.remove('hidden');
            });
            
            applyFilters();
            
            saturationSlider.value = currentSaturation;
            updateSaturation();

            updateCounter();
            updateInProgressRow();

            console.log("Сброс фильтров завершен");
        }

        function showAuthorCredit() {
            authorCredit.style.display = 'block';
            clearTimeout(authorCreditTimeout);
            authorCreditTimeout = setTimeout(() => {
                authorCredit.style.display = 'none';
            }, 3000);
        }

        completedFilter.addEventListener('click', toggleCompletedFilter);
        randomButton.addEventListener('click', selectRandomGame);
        saturationSlider.addEventListener('input', updateSaturation);

        yearSliderMin.addEventListener('input', () => {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            if (minVal > maxVal - 1) {
                yearSliderMin.value = maxVal - 1;
            }
            updateYearValue();
            applyFilters();
        });

        yearSliderMax.addEventListener('input', () => {
            const minVal = parseInt(yearSliderMin.value);
            const maxVal = parseInt(yearSliderMax.value);
            if (maxVal < minVal + 1) {
                yearSliderMax.value = minVal + 1;
            }
            updateYearValue();
            applyFilters();
        });

        sizeSlider.addEventListener('input', updateGridSize);
        togglePreviewBtn.addEventListener('click', togglePreview);
        inProgressButton.addEventListener('click', toggleInProgressMode);
        hideCompletedButton.addEventListener('click', toggleHideCompleted);
        resetButton.addEventListener('click', () => {
            resetProgress();
            hideRandomSelection();
        });
        searchInput.addEventListener('input', searchGames);
        searchInput.addEventListener('input', () => searchGames(false));
        searchInput.addEventListener('keypress', handleSearchKeyPress);
        clearSearchButton.addEventListener('click', clearSearch);
        filtersButton.addEventListener('click', (event) => {
            event.stopPropagation();
            filtersPanel.style.display = filtersPanel.style.display === 'none' ? 'block' : 'none';
        });
        resetFiltersButton.addEventListener('click', resetFilters);

        const savedSize = localStorage.getItem('gridSize');
        if (savedSize) {
            sizeSlider.value = savedSize;
            updateGridSize();
        }

        togglePreviewBtn.classList.toggle('disabled', !previewEnabled);

        populateFilters();
        games.forEach(game => {
            const cell = createCell(game);
            if (game.inProgress) {
                inProgressRow.appendChild(cell);
            } else {
                grid.appendChild(cell);
            }
        });
        updateInProgressRow();

        updateCounter();

        hideCompletedButton.classList.toggle('active', hideCompleted);
        if (hideCompleted) {
            document.querySelectorAll('.cell.completed').forEach(cell => {
                cell.classList.add('hidden');
            });
        }
        
        populateFilters();
        applyFilters();
        updateInProgressRow();

        window.addEventListener('resize', updateInProgressRow);
        updateInProgressRow();

        const resetFiltersButtonHeader = document.getElementById('resetFiltersButtonHeader');
        resetFiltersButtonHeader.addEventListener('click', function(event) {
            console.log("Кнопка сброса фильтров в шапке нажата");
            event.stopPropagation(); // Предотвращаем всплытие события
            resetFilters();
            // Не закрываем панель фильтров
        });

        document.addEventListener('click', (event) => {
            if (!randomSelectedContainer.contains(event.target) && event.target !== randomButton) {
                hideRandomSelection();
            }
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                updateGridSize();
                updateInProgressRow();
            }, 100);
        });

        window.dispatchEvent(new Event('resize'));

        const addGameButton = document.getElementById('addGameButton');
        const customGameListButton = document.getElementById('customGameListButton');
        const addGameModal = document.getElementById('addGameModal');
        const customGameListModal = document.getElementById('customGameListModal');
        const addGameForm = document.getElementById('addGameForm');
        const customGameList = document.getElementById('customGameList');

        let customGames = JSON.parse(localStorage.getItem('customGames')) || [];
      
        function deleteAllApiGames() {
            if (confirm('Вы уверены, что хотите удалить все добавленные игры?')) {
                console.log('Начало удаления всех добавленных игр');
                const initialCount = games.length;
                games = games.filter(game => !game.isCustom && !game.importedFromApi);
                const deletedCount = initialCount - games.length;
                
                // Обновляем DOM
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    const gameId = cell.getAttribute('data-game-id');
                    const game = games.find(g => g.id.toString() === gameId);
                    if (!game) {
                        cell.remove();
                    }
                });

                // Обновляем localStorage
                saveGames();
                
                // Обновляем счетчики и фильтры
                completedGames = games.filter(game => game.completed).length;
                updateCounter();
                populateFilters();
                applyFilters();
                
                console.log(`Удалено ${deletedCount} добавленных игр`);
               
                // Обновляем список пользовательских игр
                updateCustomGameList();
            }
        }

        // Добавляем обработчик события для кнопки удаления всех игр из API
        const deleteAllApiGamesButton = document.getElementById('deleteAllApiGamesButton');
        if (deleteAllApiGamesButton) {
            deleteAllApiGamesButton.addEventListener('click', deleteAllApiGames);
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            if (modal === addGameModal) {
                resetAddGameForm();
            }
        }

        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                closeModal(closeBtn.closest('.modal'));
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        });

        addGameButton.addEventListener('click', () => {
            addGameModal.style.display = 'block';
        });

        customGameListButton.addEventListener('click', () => {
            updateCustomGameList();
            customGameListModal.style.display = 'block';
        });

        let isEditing = false;
        let editingGameId = null;

        function handleFormSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('gameName').value.trim();
            
            if (!name) {
                alert('Название игры обязательно для заполнения');
                return;
            }
            
            if (!isEditing && isNameOrAbbreviationExists(name)) {
                alert('Игра с таким названием уже существует');
                return;
            }
            
            const gameData = {
                id: isEditing ? editingGameId : Date.now(), // Присваиваем ID при создании новой игры
                name: name,
                year: parseInt(document.getElementById('gameYear').value) || null,
                platforms: document.getElementById('gamePlatforms').value.split(',').map(p => p.trim()).filter(p => p),
                genres: document.getElementById('gameGenres').value.split(',').map(g => g.trim()).filter(g => g),
                imageUrl: document.getElementById('gameImageUrl').value.trim() || null,
                isCustom: true,
                importedFromApi: false,
                completed: false,
                inProgress: false,
                color: getRandomPastelColor()
            };
            
            if (isEditing) {
                updateGame(editingGameId, gameData);
            } else {
                addNewGame(gameData);
            }
            
            closeModal(addGameModal);
            resetAddGameForm();
        }

        function addNewGame(gameData) {
            console.log('Начало добавления новой игры:', gameData.name);
            const newGame = {
                id: Date.now(),
                ...gameData,
                isCustom: true,
                importedFromApi: gameData.importedFromApi || false,
                completed: false,
                inProgress: false,
                color: getRandomPastelColor()
            };
            
            console.log('Добавление игры в массив games');
            games.push(newGame);
            console.log('Сохранение обновленного списка games в localStorage');
            saveGames();
            
            console.log('Создание ячейки для новой игры');
            const cell = createCell(newGame);
            console.log('Добавление ячейки в сетку');
            grid.appendChild(cell);
            console.log('Обновление счетчика');
            updateCounter();
            console.log('Обновление фильтров');
            populateFilters();
            console.log('Применение фильтров');
            applyFilters();
            console.log('Обновление размера сетки');
            updateGridSize();
            console.log('Игра успешно добавлена:', newGame.name);
        }

        function updateGame(gameId, gameData) {
            const game = customGames.find(g => g.id.toString() === gameId);
            if (game) {
                Object.assign(game, gameData);
                localStorage.setItem('customGames', JSON.stringify(customGames));
                updateCustomGameList();
                updateGameCell(game);
            }
        }

        function editCustomGame(gameId) {
            const game = customGames.find(g => g.id.toString() === gameId);
            if (game) {
                document.getElementById('gameName').value = game.name;
                document.getElementById('gameYear').value = game.year || '';
                document.getElementById('gamePlatforms').value = game.platforms.join(', ');
                document.getElementById('gameGenres').value = game.genres.join(', ');
                document.getElementById('gameImageUrl').value = game.imageUrl || '';
                
                document.querySelector('#addGameModal h2').textContent = 'Редактировать игру';
                
                document.querySelector('#addGameForm button[type="submit"]').textContent = 'Сохранить';
                
                addGameModal.style.display = 'block';
                customGameListModal.style.display = 'none';
                
                isEditing = true;
                editingGameId = gameId;
            }
        }

        function resetAddGameForm() {
            document.getElementById('gameName').value = '';
            document.getElementById('gameYear').value = '';
            document.getElementById('gamePlatforms').value = '';
            document.getElementById('gameGenres').value = '';
            document.getElementById('gameImageUrl').value = '';
            
            document.querySelector('#addGameModal h2').textContent = 'Добавить новую игру';
            document.querySelector('#addGameForm button[type="submit"]').textContent = 'Добавить';
            
            isEditing = false;
            editingGameId = null;
        }

        addGameForm.addEventListener('submit', handleFormSubmit);

        function createCell(game) {
            console.log('Создание ячейки для игры:', game);
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.gameId = game.id.toString();
            if (game.completed) {
                cell.classList.add('completed');
            }
            if (game.inProgress) {
                cell.classList.add('in-progress');
            }
            if (game.isCustom) {
                cell.classList.add('custom-game');
            }
    
            if (game.imageUrl) {
                cell.innerHTML = `<img src="${game.imageUrl}" alt="${game.name}">`;
            } else {
                const color = game.color || getRandomPastelColor();
                if (!game.color) {
                    game.color = color;
                }
                cell.innerHTML = `<div class="abbreviation-placeholder"><span style="color: ${color};">${game.name}</span></div>`;
            }
    
            cell.title = game.name;
            cell.addEventListener('click', () => toggleCell(cell, game.id));
            cell.addEventListener('mousemove', (e) => showPreviewOrTitle(e, game));
            cell.addEventListener('mouseleave', hidePreviewAndTitle);
    
            updateCellSize(cell, game.inProgress);
    
            return cell;
        }


        function removeGameCell(gameId) {
            const cell = document.querySelector(`.cell[data-game-id="${gameId}"]`);
            if (cell) {
                cell.remove();
            }
        }

        function getRandomPastelColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 70 + Math.random() * 10;
            const lightness = 60 + Math.random() * 10;
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }

        function updateCustomGameList() {
            console.log('Обновление списка пользовательских игр');
            customGameList.innerHTML = '';
            const searchTerm = document.getElementById('customGameSearchInput').value.toLowerCase();
            
            games.forEach(game => {
                if (game.name.toLowerCase().includes(searchTerm)) {
                    const gameElement = document.createElement('div');
                    gameElement.className = 'custom-game-item';
                    gameElement.innerHTML = `
                        <span>${game.name}</span>
                        <div>
                            <button class="delete-game" data-id="${game.id}">Удалить</button>
                        </div>
                    `;
                    customGameList.appendChild(gameElement);
                }
            });
            
            customGameList.removeEventListener('click', customGameListClickHandler);
            customGameList.addEventListener('click', customGameListClickHandler);
            console.log('Список пользовательских игр обновлен');
        }

        document.getElementById('customGameSearchInput').addEventListener('input', updateCustomGameList);

        function customGameListClickHandler(e) {
            if (e.target.classList.contains('delete-game')) {
                const gameId = e.target.dataset.id;
                console.log('Клик по кнопке удаления игры с ID:', gameId);
                if (gameId) {
                    deleteGame(gameId);
                } else {
                    console.error('ID игры не найден');
                }
            }
        }

        function deleteGame(gameId) {
            console.log('Попытка удаления игры с ID:', gameId);
            if (gameId && confirm('Вы уверены, что хотите удалить эту игру?')) {
                console.log('Удаление подтверждено');
                games = games.filter(g => g.id.toString() !== gameId.toString());
                localStorage.setItem('games', JSON.stringify(games));
                console.log('Игры обновлены в localStorage');
                
                const cellToRemove = document.querySelector(`.cell[data-game-id="${gameId}"]`);
                if (cellToRemove) {
                    cellToRemove.remove();
                    console.log('Ячейка игры удалена из DOM');
                } else {
                    console.log('Ячейка игры не найдена в DOM');
                }
                
                updateCustomGameList();
                updateCounter();
                populateFilters();
                applyFilters();
                updateGridSize();
                console.log('Интерфейс обновлен после удаления игры');
            }
        }

        function updateGameCell(game) {
            const cell = document.querySelector(`.cell[data-game-id="${game.id}"]`);
            if (cell) {
                if (game.imageUrl) {
                    cell.innerHTML = `<img src="${game.imageUrl}" alt="${game.name}">`;
                } else {
                    cell.innerHTML = `<div class="abbreviation-placeholder"><span style="color: ${game.color};">${game.name}</span></div>`;
                }
                cell.title = game.name;
            }
        }

        function loadCustomGames() {
            customGames.forEach(game => {
                if (!games.some(g => g.id === game.id)) {
                    games.push(game);
                    const cell = createCell(game);
                    grid.appendChild(cell);
                }
            });
            updateGridSize();
            populateFilters();
            applyFilters();
        }

        loadCustomGames();

        function updateSaturation() {
            const saturationValue = saturationSlider.value;
            document.querySelectorAll('.cell:not(.completed)').forEach(cell => {
                const img = cell.querySelector('img');
                if (img) {
                    img.style.filter = `saturate(${saturationValue}%)`;
                }
            });
        }

        function isNameOrAbbreviationExists(name, abbreviation, excludeId = null) {
            return games.some(game => 
                ((game.name && game.name.toLowerCase() === name.toLowerCase()) || 
                (game.abbreviation && game.abbreviation.toLowerCase() === abbreviation.toLowerCase())) && 
                game.id !== excludeId
            );
        }

        const selectPlatformsBtn = document.getElementById('selectPlatformsBtn');
        const selectGenresBtn = document.getElementById('selectGenresBtn');
        const selectOptionsModal = document.getElementById('selectOptionsModal');
        const selectOptionsTitle = document.getElementById('selectOptionsTitle');
        const optionsList = document.getElementById('optionsList');
        const applyOptionsBtn = document.getElementById('applyOptionsBtn');

        let currentSelectType = '';

        function showSelectOptions(type) {
            currentSelectType = type;
            selectOptionsTitle.textContent = type === 'platforms' ? 'Выберите платформы' : 'Выберите жанры';
            
            const options = type === 'platforms' 
                ? [...new Set(games.flatMap(game => game.platforms))]
                : [...new Set(games.flatMap(game => game.genres))];
            
            const inputField = type === 'platforms' ? document.getElementById('gamePlatforms') : document.getElementById('gameGenres');
            const selectedValues = inputField.value.split(',').map(v => v.trim());
            
            optionsList.innerHTML = options.map(option => `
                <label>
                    <input type="checkbox" value="${option}" ${selectedValues.includes(option) ? 'checked' : ''}> ${option}
                </label>
            `).join('');

            selectOptionsModal.style.display = 'block';
        }

        customGameListButton.addEventListener('click', () => {
            updateCustomGameList();
            customGameListModal.style.display = 'block';
        });

        document.addEventListener('click', function(event) {
            if (event.target.id === 'selectPlatformsBtn') {
                showSelectOptions('platforms');
            } else if (event.target.id === 'selectGenresBtn') {
                showSelectOptions('genres');
            }
        });

        applyOptionsBtn.addEventListener('click', () => {
            const selectedOptions = Array.from(optionsList.querySelectorAll('input:checked')).map(input => input.value);
            const inputField = currentSelectType === 'platforms' ? document.getElementById('gamePlatforms') : document.getElementById('gameGenres');
            inputField.value = selectedOptions.join(', ');
            selectOptionsModal.style.display = 'none';
        });

        // Закрытие модального окна выбора опций
        selectOptionsModal.querySelector('.close').addEventListener('click', () => {
            selectOptionsModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === selectOptionsModal) {
                selectOptionsModal.style.display = 'none';
            }
        });

        function initializeImportButton() {
            console.log('Инициализация кнопок импорта');
            const importButton = document.getElementById('importFromApiButton');
            const importModalButton = document.getElementById('importFromApiModalButton');
            if (importButton) {
                console.log('Кнопка импорта в шапке найдена');
                importButton.addEventListener('click', () => {
                    console.log('Кнопка импорта из API в шапке нажата');
                    importFromIGDB();
                });
            } else {
                console.error('Кнопка импорта в шапке не найдена');
            }
            if (importModalButton) {
                console.log('Кнопка импорта в модальном окне найдена');
                importModalButton.addEventListener('click', () => {
                    console.log('Кнопка импорта из API в модальном окне нажата');
                    importFromIGDB();
                });
            } else {
                console.error('Кнопка импорта в модальном окне не найдена');
            }
        }

        document.addEventListener('click', (event) => {
            console.log('Клик по элементу:', event.target);
            if (event.target.id === 'importFromApiButton' || event.target.id === 'importFromApiModalButton') {
                console.log('Клик по кнопке импорта зарегистрирован через делегирование событий');
                importFromIGDB();
            }
        });

        let isImporting = false; // Флаг для предотвращения множественных импортов

        async function importFromIGDB() {
            if (isImporting) {
                console.log('Импорт уже выполняется');
                return;
            }
            isImporting = true;
            console.log('Начало импорта игр из IGDB');
            try {
                console.log('Отправка запроса на получение новых игр');
                const existingIds = games.map(game => game.id.toString());
                const chunks = chunkArray(existingIds, 1000);
                let addedGames = 0;

                for (const chunk of chunks) {
                    const response = await fetch(`https://nu3ichego5ti2suda7prishel.uhadi.workers.dev/games?existingIds=${chunk.join(',')}`);
                    console.log('Получен ответ от сервера');

                    if (!response.ok) {
                        throw new Error(`Ошибка ответа сервера: ${response.status} ${response.statusText}`);
                    }

                    const newGames = await response.json();
                    console.log('JSON успешно распарсен, получено игр:', newGames.length);

                    for (const game of newGames) {
                        if (games.length >= 2000) {
                            console.log('Достигнуто максимальное количество игр');
                            break;
                        }
                        if (!games.some(g => g.id === game.id)) {
                            console.log(`Добавление новой игры: ${game.name}`);
                            const newGame = {
                                id: game.id,
                                name: game.name,
                                imageUrl: game.cover ? convertImageUrl(game.cover.url) : '',
                                year: game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : null,
                                genres: game.genres ? game.genres.map(g => g.name) : [],
                                platforms: game.platforms ? game.platforms.map(p => p.name) : [],
                                rating: game.aggregated_rating || game.rating,
                                isCustom: true,
                                importedFromApi: true,
                                completed: false,
                                inProgress: false
                            };
                            await addNewGameWithDelay(newGame);
                            addedGames++;
                        } else {
                            console.log(`Игра "${game.name}" уже существует, пропускаем`);
                        }
                    }
                }

                console.log('Импорт завершен успешно');
                alert(`Импорт завершен. Добавлено ${addedGames} новых игр.`);
            } catch (error) {
                console.error('Ошибка при импорте игр из IGDB:', error);
                alert(`Не удалось импортировать игры: ${error.message}`);
            } finally {
                isImporting = false;
            }
        }

        function addNewGameWithDelay(game) {
            return new Promise(resolve => {
                setTimeout(() => {
                    addNewGame(game);
                    saveGames();
                    updateFiltersAndCounter();
                    resolve();
                }, 20);
            });
        }

        function addNewGame(game) {
            games.push(game);
            const cell = createCell(game);
            grid.appendChild(cell);
            updateGridSize();
        }

        function convertImageUrl(url) {
            const baseUrl = 'https://images.igdb.com/igdb/image/upload/t_cover_big/';
            const fileName = url.split('/').pop();
            return baseUrl + fileName;
        }

        function updateFiltersAndCounter() {
            populateFilters();
            updateCounter();
        }

        function chunkArray(array, size) {
            const chunked = [];
            for (let i = 0; i < array.length; i += size) {
                chunked.push(array.slice(i, i + size));
            }
            return chunked;
        }

        function initializeImportButton() {
            console.log('Инициализация кнопок импорта');
            const importButton = document.getElementById('importFromApiButton');
            const importModalButton = document.getElementById('importFromApiModalButton');
            if (importButton) {
                console.log('Кнопка импорта в шапке найдена');
                importButton.addEventListener('click', importFromIGDB);
            } else {
                console.error('Кнопка импорта в шапке не найдена');
            }
            if (importModalButton) {
                console.log('Кнопка импорта в модальном окне найдена');
                importModalButton.addEventListener('click', importFromIGDB);
            } else {
                console.error('Кнопка импорта в модальном окне не найдена');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM полностью загружен');
            initializeImportButton();
            loadSavedGames();
            renderGames();
            updateCounter();
            populateFilters();
            applyFilters();
            updateInProgressRow();

            // Добавляем обработчик события для кнопки "Добавить игру" в шапке
            const addGameButton = document.getElementById('addGameButton');
            const addGameModal = document.getElementById('addGameModal');
            
            if (addGameButton) {
                addGameButton.addEventListener('click', () => {
                    console.log('Кнопка "Добавить игру" в шапке нажата');
                    addGameModal.style.display = 'block';
                });
            } else {
                console.error('Кнопка "Добавить игру" в шапке не найдена');
            }

            // Инициализация кнопок импорта и поиска
            const importApiButton = document.getElementById('importFromApiButton');
            const importApiModalButton = document.getElementById('importFromApiModalButton');
            const searchGameButton = document.getElementById('searchGameButton');

            if (importApiButton) {
                importApiButton.addEventListener('click', () => {
                    console.log('Кнопка импорта из API в шапке нажата (из основного обработчика)');
                    importFromIGDB();
                });
            }

            if (importApiModalButton) {
                importApiModalButton.addEventListener('click', () => {
                    console.log('Кнопка импорта из API в модальном окне нажата (из основного обработчика)');
                    importFromIGDB();
                });
            }

            if (searchGameButton) {
                searchGameButton.addEventListener('click', () => {
                    console.log('Кнопка поиска игры нажата');
                    searchGame();
                });
            }
        });
    </script>
</body>
</html>